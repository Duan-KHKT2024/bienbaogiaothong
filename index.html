<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Nhận Diện Biển Báo Giao Thông</title>
    <!-- Thêm Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables cho dễ bảo trì */
        :root {
            --primary-color: #28a745;
            --secondary-color: #007bff;
            --accent-color: #17a2b8;
            --warning-color: #ffc107;
            --purple-color: #6f42c1;
            --dark-color: #333;
            --light-bg: #f0f4f8;
            --white-bg: #fff;
            --text-color: #555;
            --error-color: #d9534f;
            --disabled-color: #cccccc;
            --focus-outline: #ffbf47;
            --accordion-bg: #e9ecef;
            --accordion-hover: #dee2e6;
            --accordion-active: #ced4da;
            --qa-question-font: 'Roboto', sans-serif;
            --qa-answer-font: 'Open Sans', sans-serif;
            --question-color: #2c3e50; /* Màu xanh đậm cho câu hỏi */
        }

        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--qa-question-font); /* Sử dụng Roboto cho toàn bộ trang */
            background-color: var(--light-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        h1 {
            color: var(--dark-color);
            margin-bottom: 20px;
            font-size: 2em;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--white-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; /* Để overlay hoạt động đúng */
        }

        /* Điều chỉnh chiều cao video cho thiết bị di động */
        #video, #capturedImage {
            border: 4px solid var(--primary-color);
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            height: auto;
            max-height: 400px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: opacity 0.5s ease, transform 0.3s ease;
            object-fit: cover;
        }

        #capturedImage {
            display: none;
            opacity: 0;
        }

        /* Cải thiện thiết kế Overlay */
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60%; /* Giảm kích thước để tạo không gian xung quanh */
            height: 60%;
            transform: translate(-50%, -50%);
            border: 3px solid rgba(40, 167, 69, 0.8); /* Sử dụng màu sắc trong suốt */
            border-radius: 20px; /* Đường viền tròn hơn để thẩm mỹ */
            box-sizing: border-box;
            pointer-events: none; /* Không chặn các tương tác với video */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* Thêm bóng đổ để nổi bật */
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
        }

        button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            flex: 1 1 160px; /* Đảm bảo nút có cùng kích thước */
            max-width: 220px; /* Giới hạn kích thước tối đa */
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: #fff;
            text-align: center;
            min-height: 44px; /* Đảm bảo touch target đủ lớn */
        }

        /* Các màu sắc cho các nút */
        #captureButton {
            background-color: var(--primary-color);
        }

        #uploadButton {
            background-color: var(--secondary-color);
        }

        #downloadButton {
            background-color: var(--secondary-color);
            display: none; /* Ẩn ban đầu */
        }

        #readButton {
            background-color: var(--accent-color);
            display: none; /* Initially hidden */
        }

        #retakeButton {
            background-color: var(--warning-color);
            display: none;
            color: var(--dark-color);
        }

        #quizButton {
            background-color: var(--purple-color);
            display: none; /* Initially hidden */
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.05);
        }

        button:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        button:focus {
            outline: 3px solid var(--focus-outline); /* Màu nổi bật khi focus */
            outline-offset: 2px;
        }

        @media (max-width: 600px) {
            button {
                width: 100%;
                max-width: 220px;
            }
        }

        #predictionResult {
            margin-top: 20px;
            font-size: 16px; /* Giảm kích thước font chữ */
            font-weight: bold;
            color: var(--dark-color);
            min-height: 50px;
            text-align: center;
            width: 100%;
        }

        /* Định dạng hướng dẫn sử dụng */
        #predictionResult h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--primary-color);
            text-align: center;
        }

        #predictionResult ol {
            text-align: left;
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            padding-left: 20px;
            font-size: 0.9em; /* Giảm kích thước font chữ */
            color: var(--text-color);
            list-style-position: inside; /* Căn đều các dấu đầu dòng */
            font-family: var(--qa-answer-font); /* Sử dụng Open Sans cho danh sách */
        }

        #predictionResult li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        /* Định dạng số lượng biển báo */
        #signCount {
            margin-top: 10px;
            font-size: 16px;
            color: var(--error-color); /* Màu đỏ để làm nổi bật */
            text-align: center;
            font-weight: bold;
        }

        #signMeaning {
            margin-top: 10px;
            font-size: 16px;
            color: var(--text-color);
            text-align: center;
            max-width: 600px;
            position: relative;
            word-wrap: break-word; /* Đảm bảo dòng dài được xuống dòng */
        }

        /* Loading Spinner Styles */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingModel, #loadingPrediction {
            margin-top: 20px;
            font-size: 18px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer {
            width: 100%;
            text-align: center;
            padding-top: 20px;
            font-size: 14px;
            color: #888;
        }

        /* Nút "Làm Bài Kiểm Tra" */
        #quizButton-container {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        /* Phần Hỏi Đáp (QA) */
        .qa-section {
            width: 100%;
            max-width: 600px;
            margin-top: 30px;
            background-color: var(--accordion-bg);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .qa-section h2 {
            text-align: center;
            color: var(--dark-color);
            margin-bottom: 20px;
            font-size: 1.8em;
            font-family: var(--qa-question-font);
        }

        .accordion {
            background-color: var(--white-bg);
            color: var(--question-color); /* Đổi màu sắc của câu hỏi */
            cursor: pointer;
            padding: 20px; /* Tăng padding để làm rộng chiều dài */
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.1em; /* Tăng kích thước font chữ */
            font-weight: 700; /* Tăng độ đậm của font chữ */
            transition: background-color 0.3s ease;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: var(--qa-question-font);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .accordion:hover {
            background-color: var(--accordion-hover);
        }

        .accordion.active {
            background-color: var(--accordion-active);
        }

        /* Biểu tượng mũi tên cho accordion */
        .accordion::after {
            content: '\002B'; /* Plus sign */
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .accordion.active::after {
            content: '\2212'; /* Minus sign */
        }

        /* Panel styles with smooth transition */
        .panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background-color: var(--white-bg);
            border-left: 3px solid var(--primary-color);
            border-right: 3px solid var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            border-radius: 0 0 5px 5px;
            margin-bottom: 15px;
        }

        .panel.show {
            max-height: 500px; /* Adjust as needed */
        }

        .panel p {
            padding: 10px 15px;
            color: var(--text-color);
            font-family: var(--qa-answer-font);
            line-height: 1.6;
        }

        .panel ul {
            list-style-type: disc;
            padding-left: 30px;
            font-family: var(--qa-answer-font);
            color: var(--text-color);
            line-height: 1.6;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Nhận Diện Biển Báo Giao Thông</h1>
        <div style="position: relative; width: 100%; max-width: 600px;">
            <video id="video" autoplay playsinline aria-label="Video từ camera"></video>
            <div class="overlay"></div>
        </div>
        <img id="capturedImage" alt="Ảnh đã chụp">
        <canvas id="canvas" style="display: none;"></canvas>

        <div class="button-container">
            <button id="captureButton" aria-label="Chụp ảnh">Bắt Đầu</button>
            <button id="uploadButton" aria-label="Tải ảnh lên">Tải Ảnh Lên</button>
            <button id="downloadButton" aria-label="Tải ảnh xuống">Tải Ảnh Xuống</button>
            <button id="readButton" aria-label="Đọc ý nghĩa biển báo">Đọc</button>
            <button id="retakeButton" aria-label="Chụp lại">Chụp Lại</button>
        </div>

        <!-- Hidden file input for uploading images -->
        <input type="file" id="uploadInput" accept="image/*" style="display: none;" />

        <div id="loadingModel">
            Đang tải mô hình...
            <div class="spinner"></div>
        </div>
        <div id="loadingPrediction" style="display: none;">
            Đang nhận diện...
            <div class="spinner"></div>
        </div>
        <div id="predictionResult" aria-live="polite">
            <h2>Hướng Dẫn Sử Dụng</h2>
            <ol>
                <li>Nhấn nút <strong>"Bắt Đầu"</strong> để khởi động camera.</li>
                <li>Khi camera đã khởi động, nhấn nút <strong>"Chụp Ảnh"</strong> để bắt đầu quá trình chụp hình biển báo giao thông.</li>
                <li>Đảm bảo camera của bạn được đặt sao cho biển báo rõ ràng và trung tâm trong khung hình.</li>
                <li>Sau khi chụp, hệ thống sẽ tự động nhận diện biển báo và hiển thị kết quả.</li>
                <li>Nhấn nút <strong>"Đọc"</strong> để nghe lại ý nghĩa của biển báo đã nhận diện.</li>
                <li>Chọn nút <strong>"Làm Bài Kiểm Tra"</strong> để thực hiện bài kiểm tra giao thông.</li>
            </ol>
            <p id="signCount">Số lượng biển báo có thể nhận diện: <strong id="totalSigns">0</strong></p>
        </div>
        <div id="signMeaning" aria-live="polite"></div>

        <!-- Phần Hỏi Đáp (QA) -->
        <div class="qa-section">
            <h2>Hỏi Đáp</h2>

            <!-- Câu hỏi 1 -->
            <button class="accordion" aria-expanded="false" aria-controls="panel1">1. Những quy định tham gia giao thông của học sinh</button>
            <div class="panel" id="panel1">
                <p>
                    Học sinh khi tham gia giao thông cần tuân thủ các quy định sau:
                </p>
                <ul>
                    <li>Luôn đội mũ bảo hiểm khi đi xe máy.</li>
                    <li>Đi đúng làn đường, tuân thủ tín hiệu đèn giao thông.</li>
                    <li>Không sử dụng điện thoại di động khi lái xe.</li>
                    <li>Giữ khoảng cách an toàn với các phương tiện khác.</li>
                    <li>Tuân thủ giới hạn tốc độ quy định.</li>
                </ul>
            </div>

            <!-- Câu hỏi 2 -->
            <button class="accordion" aria-expanded="false" aria-controls="panel2">2. Những quy tắc đội mũ bảo hiểm</button>
            <div class="panel" id="panel2">
                <p>
                    Để đảm bảo an toàn khi tham gia giao thông, học sinh cần tuân thủ các quy tắc sau khi đội mũ bảo hiểm:
                </p>
                <ul>
                    <li>Chọn mũ bảo hiểm đạt tiêu chuẩn an toàn.</li>
                    <li>Điều chỉnh dây quai sao cho vừa vặn, không quá chặt hay quá lỏng.</li>
                    <li>Kiểm tra mũ bảo hiểm trước mỗi chuyến đi để đảm bảo không bị hư hỏng.</li>
                    <li>Không đội mũ bảo hiểm bị trầy xước hoặc móp méo.</li>
                    <li>Đội mũ bảo hiểm đúng cách, đảm bảo che kín trán và cằm.</li>
                </ul>
            </div>

            <!-- Thêm các câu hỏi khác nếu cần -->
            <!-- Câu hỏi 3 -->
            <button class="accordion" aria-expanded="false" aria-controls="panel3">3. Cách sử dụng đèn tín hiệu giao thông</button>
            <div class="panel" id="panel3">
                <p>
                    Khi sử dụng đèn tín hiệu giao thông, học sinh cần lưu ý:
                </p>
                <ul>
                    <li>Luôn quan sát đèn tín hiệu trước khi di chuyển.</li>
                    <li>Dừng lại khi đèn đỏ và chỉ đi khi đèn xanh.</li>
                    <li>Sử dụng đèn xi-nhan khi rẽ để thông báo cho các phương tiện khác.</li>
                    <li>Tránh di chuyển khi đèn chuyển đổi để đảm bảo an toàn.</li>
                </ul>
            </div>
        </div>

        <!-- Nút "Làm Bài Kiểm Tra" Đặt Dưới Phần Hỏi Đáp -->
        <div id="quizButton-container">
            <button id="quizButton" aria-label="Làm bài kiểm tra" title="Làm bài kiểm tra giao thông">Làm Bài Kiểm Tra</button>
        </div>
    </div>

    <div class="footer">
        &copy; 2024 Ứng dụng Nhận Diện Biển Báo Giao Thông
    </div>

    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>

    <script>
        // Các phần tử DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const uploadButton = document.getElementById('uploadButton');
        const uploadInput = document.getElementById('uploadInput'); // Hidden file input
        const downloadButton = document.getElementById('downloadButton');
        const readButton = document.getElementById('readButton');
        const retakeButton = document.getElementById('retakeButton');
        const capturedImage = document.getElementById('capturedImage');
        const predictionResult = document.getElementById('predictionResult');
        const signMeaning = document.getElementById('signMeaning');
        const loadingModel = document.getElementById('loadingModel');
        const loadingPrediction = document.getElementById('loadingPrediction');
        const signCount = document.getElementById('totalSigns');
        const quizButton = document.getElementById('quizButton');
        const overlay = document.querySelector('.overlay');
        let stream = null;
        let isProcessing = false;
        let cameraStarted = false; // Biến trạng thái camera
        const MODEL_URL = "https://duan-khkt2024.github.io/bienbaogiaothong/model/";
        let model;
        let labels = []; // Danh sách nhãn sẽ được tải từ metadata.json

        // Định nghĩa ý nghĩa của các biển báo
        const signMeanings = {
            "P.101": "Biển báo Đường cấm: Dùng để báo trước nơi giao nhau có điều khiển giao thông bằng tín hiệu đèn đỏ, hãy chú ý dừng lại. Cần chú ý quan sát, giảm tốc độ để đảm bảo an toàn khi tham gia giao thông.",
            "W.208": "Biển báo Giao nhau với đường ưu tiên: Các xe đi trên đường phải nhường đường cho xe đi trên đường ưu tiên. Cần chú ý quan sát, giảm tốc độ để đảm bảo an toàn khi tham gia giao thông.",
            "W.205": "Biển báo giao nhau với đường cùng cấp: Dùng để báo trước sắp đến nơi giao nhau với đường cùng cấp (không có đường nào ưu tiên). Cần chú ý quan sát, giảm tốc độ để đảm bảo an toàn khi tham gia giao thông.",
            "W.207": "Biển báo giao nhau với đường không ưu tiên: Chỉ được đặt trên đường ưu tiên. Báo trước sắp đến nơi giao nhau với đường không ưu tiên. Cần chú ý quan sát, giảm tốc độ để đảm bảo an toàn khi tham gia giao thông.",
            "P.103": "Biển báo cấm xe ô tô. Dùng để báo đường cấm các loại xe cơ giới kể cả xe máy 3 bánh có thùng đi qua, trừ xe máy 2 bánh, xe gắn máy và các xe được ưu tiên theo quy định. Cần chú ý quan sát, giảm tốc độ để đảm bảo an toàn khi tham gia giao thông.",

            // Thêm các ý nghĩa cho các biển báo khác ở đây
        };

        /**
         * Hàm khởi động camera
         */
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        // Optional: thêm các constraints khác nếu cần
                    },
                    audio: false
                });
                video.srcObject = stream;
                return new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                    video.onerror = (err) => {
                        reject(err);
                    };
                });
            } catch (err) {
                console.error("Không thể truy cập camera: ", err);
                alert("Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc thiết bị của bạn.");
            }
        }

        /**
         * Hàm chụp ảnh từ video
         */
        async function capturePhoto() {
            if (isProcessing) return;
            isProcessing = true;
            captureButton.disabled = true;

            if (!cameraStarted) {
                // Nếu camera chưa được khởi động, bắt đầu camera
                try {
                    await startCamera();
                    cameraStarted = true;
                    captureButton.textContent = "Chụp Ảnh"; // Thay đổi nhãn nút sau khi camera đã khởi động
                } catch (err) {
                    console.error("Lỗi khi khởi động camera: ", err);
                    alert("Không thể khởi động camera.");
                } finally {
                    isProcessing = false;
                    captureButton.disabled = false;
                }
            } else {
                // Nếu camera đã được khởi động, tiến hành chụp ảnh
                loadingPrediction.style.display = 'flex';

                try {
                    // Kiểm tra xem video đã sẵn sàng chưa
                    if (video.readyState < 3) { // HAVE_CURRENT_DATA = 2, HAVE_FUTURE_DATA = 3
                        await new Promise((resolve) => {
                            video.oncanplay = () => {
                                resolve();
                            };
                        });
                    }

                    const context = canvas.getContext('2d');
                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;

                    if (videoWidth === 0 || videoHeight === 0) {
                        throw new Error("Video chưa sẵn sàng.");
                    }

                    // Kích thước và vị trí của overlay (60% chiều rộng và chiều cao)
                    const overlayWidth = videoWidth * 0.6;
                    const overlayHeight = videoHeight * 0.6;
                    const sx = (videoWidth - overlayWidth) / 2;
                    const sy = (videoHeight - overlayHeight) / 2;

                    // Cài đặt kích thước canvas theo kích thước overlay
                    canvas.width = overlayWidth;
                    canvas.height = overlayHeight;

                    // Vẽ phần ảnh trong khu vực overlay vào canvas
                    context.drawImage(video, sx, sy, overlayWidth, overlayHeight, 0, 0, overlayWidth, overlayHeight);

                    const imageDataURL = canvas.toDataURL('image/png');
                    capturedImage.src = imageDataURL;
                    capturedImage.style.display = 'block';
                    capturedImage.style.opacity = 1;
                    video.style.opacity = 0;
                    video.style.display = 'none';
                    downloadButton.style.display = 'inline-block';
                    retakeButton.style.display = 'inline-block';
                    // Không ẩn nút "Chụp Ảnh" để người dùng có thể chụp lại nếu cần
                    predictionResult.innerHTML = "";
                    signMeaning.textContent = "";
                    readButton.style.display = 'none'; // Ẩn nút đọc ban đầu
                    quizButton.style.display = 'none'; // Ẩn nút kiểm tra ban đầu
                    overlay.style.display = 'none'; // Ẩn overlay sau khi chụp
                    await predictImage();
                } catch (error) {
                    console.error("Lỗi khi chụp ảnh: ", error);
                    alert("Đã xảy ra lỗi khi chụp ảnh. Vui lòng thử lại.");
                } finally {
                    isProcessing = false;
                    captureButton.disabled = false;
                }
            }
        }

        /**
         * Hàm tải ảnh xuống
         */
        function downloadPhoto() {
            if (!capturedImage.src) {
                alert("Không có ảnh nào để tải xuống.");
                return;
            }
            const link = document.createElement('a');
            link.href = capturedImage.src;
            link.download = 'anh-chup.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Hàm chụp lại ảnh
         */
        function retakePhoto() {
            capturedImage.style.display = 'none';
            capturedImage.style.opacity = 0;
            video.style.display = 'block';
            video.style.opacity = 1;
            downloadButton.style.display = 'none';
            readButton.style.display = 'none';
            retakeButton.style.display = 'none';
            quizButton.style.display = 'none';
            captureButton.style.display = 'inline-block';
            captureButton.textContent = "Chụp Ảnh"; // Reset nhãn nút sau khi chụp lại
            predictionResult.innerHTML = `
                <h2>Hướng Dẫn Sử Dụng</h2>
                <ol>
                    <li>Nhấn nút <strong>"Chụp Ảnh"</strong> để bắt đầu quá trình chụp hình biển báo giao thông.</li>
                    <li>Đảm bảo camera của bạn được đặt sao cho biển báo rõ ràng và trung tâm trong khung hình.</li>
                    <li>Sau khi chụp, hệ thống sẽ tự động nhận diện biển báo và hiển thị kết quả.</li>
                    <li>Nhấn nút <strong>"Đọc"</strong> để nghe lại ý nghĩa của biển báo đã nhận diện.</li>
                    <li>Chọn nút <strong>"Làm Bài Kiểm Tra"</strong> để thực hiện bài kiểm tra giao thông.</li>
                </ol>
                <p id="signCount">Số lượng biển báo có thể nhận diện: <strong id="totalSigns">0</strong></p>
            `;
            signMeaning.textContent = "";
            overlay.style.display = 'block'; // Hiển thị lại overlay khi chụp lại
            cameraStarted = false; // Reset trạng thái camera
            // Hiển thị lại video nếu nó đã bị ẩn
            video.style.display = 'block';
            video.style.opacity = 1;
        }

        /**
         * Hàm đọc văn bản bằng giọng nói
         * @param {string} text - Văn bản cần đọc
         */
        function speakText(text) {
            if (!('speechSynthesis' in window)) {
                console.warn('Trình duyệt của bạn không hỗ trợ Speech Synthesis.');
                return;
            }

            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance(text);
            const voices = synth.getVoices();
            const vietnameseVoices = voices.filter(voice => voice.lang.startsWith('vi'));

            if (vietnameseVoices.length > 0) {
                utterThis.voice = vietnameseVoices[0];
            }

            synth.speak(utterThis);
        }

        /**
         * Hàm tải mô hình TensorFlow.js
         */
        async function loadModel() {
            try {
                // Tải mô hình từ GitHub Pages
                model = await tf.loadLayersModel(MODEL_URL + "model.json");
                loadingModel.style.display = 'none';

                // Tải metadata.json để lấy nhãn
                const response = await fetch(MODEL_URL + "metadata.json");
                if (response.ok) {
                    const metadata = await response.json();
                    if (metadata.labels && Array.isArray(metadata.labels)) {
                        labels = metadata.labels;
                        signCount.textContent = labels.length;

                        // Lưu labels vào biến toàn cục để sử dụng sau
                        window.labels = labels;
                    } else {
                        console.warn("metadata.json không chứa trường 'labels' hoặc không phải là một mảng.");
                        // Nếu không có labels trong metadata.json, bạn có thể định nghĩa nhãn trực tiếp ở đây
                        window.labels = ["P.101", "W.208", "W.205", "W.207", "P.103"]; // Thay đổi theo nhu cầu
                        signCount.textContent = window.labels.length;
                    }
                } else {
                    console.warn("Không thể tải metadata.json. Sử dụng nhãn từ mã JavaScript hoặc định nghĩa trong metadata.json.");
                    // Nếu không thể tải metadata.json, định nghĩa nhãn trực tiếp trong mã JavaScript
                    window.labels = ["P.101", "W.208", "W.205", "W.207", "P.103"]; // Thay đổi theo nhu cầu
                    signCount.textContent = window.labels.length;
                }
            } catch (err) {
                console.error("Lỗi khi tải mô hình: ", err);
                loadingModel.textContent = "Không thể tải mô hình.";
            }
        }

        /**
         * Hàm thực hiện dự đoán hình ảnh
         */
        async function predictImage() {
            if (!model) {
                predictionResult.textContent = "Mô hình chưa được tải. Vui lòng thử lại sau.";
                loadingPrediction.style.display = 'none';
                return;
            }

            try {
                // Sử dụng tf.tidy để giải phóng bộ nhớ sau khi thực hiện dự đoán
                tf.tidy(() => {
                    // Chuyển đổi canvas thành tensor
                    const img = tf.browser.fromPixels(canvas);
                    const resized = tf.image.resizeBilinear(img, [224, 224]); // Thay đổi kích thước theo mô hình của bạn
                    const normalized = resized.div(255.0).expandDims();

                    // Thực hiện dự đoán
                    const predictions = model.predict(normalized);
                    const data = predictions.dataSync();

                    // Tìm lớp có xác suất cao nhất
                    let maxProb = -1;
                    let maxIndex = -1;
                    for (let i = 0; i < data.length; i++) {
                        if (data[i] > maxProb) {
                            maxProb = data[i];
                            maxIndex = i;
                        }
                    }

                    if (maxIndex !== -1 && window.labels) {
                        const predictedClass = window.labels[maxIndex];
                        predictionResult.innerHTML = `<span style="color: var(--primary-color);">Kết quả: ${predictedClass} (${(maxProb * 100).toFixed(2)}%)</span>`;
                        const signCode = predictedClass.substring(0, 5).toUpperCase();
                        if (signMeanings.hasOwnProperty(signCode)) {
                            const meaningText = `Ý nghĩa: ${signMeanings[signCode]}`;
                            signMeaning.textContent = meaningText;
                            readButton.style.display = 'inline-block';
                            quizButton.style.display = 'inline-block';
                        } else {
                            signMeaning.textContent = "Ý nghĩa: Không tìm thấy ý nghĩa cho biển báo này.";
                            readButton.style.display = 'inline-block';
                            quizButton.style.display = 'inline-block';
                        }
                    } else {
                        predictionResult.innerHTML = `<span style="color: var(--error-color);">Không có kết quả nhận diện.</span>`;
                        signMeaning.textContent = "";
                        readButton.style.display = 'none';
                        quizButton.style.display = 'none';
                    }
                });
            } catch (err) {
                console.error("Lỗi khi nhận diện hình ảnh: ", err);
                predictionResult.innerHTML = `<span style="color: var(--error-color);">Lỗi khi nhận diện hình ảnh.</span>`;
                signMeaning.textContent = "";
                readButton.style.display = 'none';
                quizButton.style.display = 'none';
            } finally {
                loadingPrediction.style.display = 'none';
            }
        }

        /**
         * Event listener cho nút "Đọc"
         */
        readButton.addEventListener('click', () => {
            const text = signMeaning.textContent.replace(/^Ý nghĩa: /, ""); // Loại bỏ tiền tố "Ý nghĩa: " nếu cần
            if (text) {
                speakText(text);
            }
        });

        /**
         * Event listener cho nút làm bài kiểm tra
         */
        quizButton.addEventListener('click', () => {
            window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank');
        });

        /**
         * Cập nhật danh sách giọng nói khi chúng thay đổi
         */
        window.speechSynthesis.onvoiceschanged = function() {
            window.speechSynthesis.getVoices();
        };

        /**
         * Khởi động ứng dụng khi trang được tải
         */
        window.addEventListener('load', async () => {
            await loadModel();
            // Không khởi động camera ngay khi tải trang
        });

        /**
         * Dừng camera khi trang được đóng hoặc tải lại
         */
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // Event listener cho nút "Chụp Ảnh"
        captureButton.addEventListener('click', capturePhoto);

        // Event listener cho nút "Chụp Lại"
        retakeButton.addEventListener('click', retakePhoto);

        // Thêm sự kiện cho nút "Tải Ảnh Xuống"
        downloadButton.addEventListener('click', downloadPhoto);

        // Event listener cho nút "Tải Ảnh Lên"
        uploadButton.addEventListener('click', () => {
            uploadInput.click(); // Trigger click on hidden file input
        });

        // Event listener cho việc chọn file từ file input
        uploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    capturedImage.src = e.target.result;
                    capturedImage.style.display = 'block';
                    capturedImage.style.opacity = 1;
                    video.style.opacity = 0;
                    video.style.display = 'none';
                    downloadButton.style.display = 'inline-block';
                    retakeButton.style.display = 'inline-block';
                    predictionResult.innerHTML = "";
                    signMeaning.textContent = "";
                    readButton.style.display = 'none'; // Ẩn nút đọc ban đầu
                    quizButton.style.display = 'none'; // Ẩn nút kiểm tra ban đầu
                    overlay.style.display = 'none'; // Ẩn overlay sau khi tải ảnh lên

                    // Vẽ ảnh lên canvas để dự đoán
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const context = canvas.getContext('2d');
                        // Tính toán tỷ lệ để giữ nguyên tỉ lệ ảnh khi vẽ vào canvas
                        const aspectRatio = img.width / img.height;
                        let canvasWidth = 224; // Kích thước chuẩn cho mô hình
                        let canvasHeight = 224;
                        if (aspectRatio > 1) {
                            canvasHeight = canvasWidth / aspectRatio;
                        } else {
                            canvasWidth = canvasHeight * aspectRatio;
                        }
                        canvas.width = canvasWidth;
                        canvas.height = canvasHeight;
                        context.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                        predictImage();
                    };
                };
                reader.readAsDataURL(file);
            } else {
                alert("Vui lòng chọn một tệp ảnh hợp lệ.");
            }
        });

        /**
         * Xử lý accordion trong phần Hỏi Đáp (QA)
         */
        document.querySelectorAll('.accordion').forEach(button => {
            button.addEventListener('click', function() {
                const isActive = this.classList.contains('active');
                this.setAttribute('aria-expanded', !isActive);
                this.classList.toggle('active');
                const panel = this.nextElementSibling;
                if (panel.classList.contains('show')) {
                    panel.classList.remove('show');
                } else {
                    panel.classList.add('show');
                }
            });
        });
    </script>

</body>
</html>
