<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truy cập Camera</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        video {
            width: 80%;
            max-width: 600px;
            border: 2px solid #ccc;
            border-radius: 8px;
            background-color: #000;
        }
        .controls {
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <video id="video" autoplay playsinline></video>
    <div class="controls">
        <button id="frontCamera" disabled>Camera Trước</button>
        <button id="rearCamera" disabled>Camera Sau</button>
    </div>

    <script>
        const videoElement = document.getElementById('video');
        const frontCameraButton = document.getElementById('frontCamera');
        const rearCameraButton = document.getElementById('rearCamera');

        let currentStream = null;
        let frontCameraId = null;
        let rearCameraId = null;

        // Hàm để khởi động camera bằng deviceId
        async function startCamera(deviceId) {
            if (currentStream) {
                // Dừng các track hiện tại trước khi khởi động lại
                currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: deviceId ? { deviceId: { exact: deviceId } } : true,
                audio: false
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                videoElement.srcObject = stream;
            } catch (error) {
                console.error('Lỗi khi truy cập camera: ', error);
                alert('Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc thiết bị của bạn.');
            }
        }

        // Hàm để liệt kê các thiết bị video và gán deviceId cho các nút
        async function enumerateDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                if (videoDevices.length === 0) {
                    alert('Không tìm thấy camera nào trên thiết bị của bạn.');
                    return;
                }

                // Nếu chỉ có một camera, chỉ bật nút Camera Trước
                if (videoDevices.length === 1) {
                    frontCameraId = videoDevices[0].deviceId;
                    frontCameraButton.disabled = false;
                    rearCameraButton.disabled = true;
                } else {
                    // Nếu có nhiều hơn một camera, phân loại dựa trên label hoặc vị trí
                    // Lưu ý: Trên một số trình duyệt, label chỉ xuất hiện sau khi người dùng đã cấp quyền truy cập camera
                    videoDevices.forEach(device => {
                        if (device.label.toLowerCase().includes('front') || device.label === '') {
                            frontCameraId = device.deviceId;
                        } else if (device.label.toLowerCase().includes('back') || device.label === '') {
                            rearCameraId = device.deviceId;
                        }
                    });

                    // Nếu không thể phân loại dựa trên label, phân bổ theo thứ tự
                    if (!frontCameraId) frontCameraId = videoDevices[0].deviceId;
                    if (!rearCameraId && videoDevices.length > 1) rearCameraId = videoDevices[1].deviceId;

                    frontCameraButton.disabled = false;
                    rearCameraButton.disabled = false;
                }

                // Bật camera mặc định (Camera Trước nếu có, ngược lại camera đầu tiên)
                if (frontCameraId) {
                    startCamera(frontCameraId);
                } else {
                    startCamera(videoDevices[0].deviceId);
                }

            } catch (error) {
                console.error('Lỗi khi liệt kê thiết bị: ', error);
                alert('Không thể liệt kê thiết bị. Vui lòng kiểm tra quyền truy cập hoặc trình duyệt của bạn.');
            }
        }

        // Sự kiện khi nhấn nút Camera Trước
        frontCameraButton.addEventListener('click', () => {
            if (frontCameraId) {
                startCamera(frontCameraId);
            } else {
                alert('Không tìm thấy Camera Trước.');
            }
        });

        // Sự kiện khi nhấn nút Camera Sau
        rearCameraButton.addEventListener('click', () => {
            if (rearCameraId) {
                startCamera(rearCameraId);
            } else {
                alert('Không tìm thấy Camera Sau.');
            }
        });

        // Khởi động camera và liệt kê thiết bị khi tải trang
        window.addEventListener('load', () => {
            // Yêu cầu quyền truy cập camera trước khi liệt kê thiết bị để có thể lấy label
            navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(stream => {
                    // Dừng stream ngay lập tức sau khi đã lấy thông tin thiết bị
                    stream.getTracks().forEach(track => track.stop());
                    enumerateDevices();
                })
                .catch(error => {
                    console.error('Lỗi khi truy cập camera để liệt kê thiết bị: ', error);
                    alert('Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc thiết bị của bạn.');
                });
        });
    </script>

</body>
</html>
