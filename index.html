<!DOCTYPE html>
<html lang="vi">
<head>
    <!-- Metadata -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Nhận Diện Biển Báo Giao Thông</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <!-- CSS Styles -->
    <style>
        /* CSS Variables và các kiểu CSS khác giữ nguyên */
        :root {
            --primary-color: #28a745;
            --secondary-color: #007bff;
            --accent-color: #17a2b8;
            --warning-color: #ffc107;
            --purple-color: #6f42c1;
            --dark-color: #333;
            --light-bg: #f0f4f8;
            --white-bg: #fff;
            --text-color: #654321;
            --error-color: #d9534f;
            --disabled-color: #cccccc;
            --focus-outline: #ffbf47;
            --accordion-bg: #e9ecef;
            --accordion-hover: #dee2e6;
            --accordion-active: #ced4da;
            --qa-question-font: 'Roboto', sans-serif;
            --qa-answer-font: 'Open Sans', sans-serif;
            --question-color: #654321;
            --slogan-font: 'Roboto', sans-serif;
            --slogan-color: #ffffff;
            --slogan-bg-color: var(--footer-bg-color);
            --slogan-padding: 20px;
            --slogan-border-radius: 15px;
            --slogan-font-size: 1.2em;
            --slogan-transition: opacity 1s ease-in-out;
            --footer-bg-color: #007bff;
            --footer-text-color: #ffffff;
            --modal-bg-color: rgba(0, 0, 0, 0.6);
            --modal-content-bg: #ffffff;
            --modal-content-border: #28a745;
            --modal-padding: 30px;
            --modal-border-radius: 10px;
            --modal-title-color: var(--primary-color);
            --modal-text-color: #333;
            --learning-bg-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --card-border-color: #dee2e6;
            --card-hover-bg: #e9ecef;
            --card-hover-transform: translateY(-5px);
            --card-transition: transform 0.3s ease, background-color 0.3s ease;
            --section-title-bg: #007bff;
            --section-title-color: #ffffff;
            --section-title-padding: 10px 20px;
            --section-title-border-radius: 8px 8px 0 0;
            --fixed-slogan-width: 100%;
            --fixed-slogan-height: 80px;
        }

        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--qa-question-font);
            background-color: var(--light-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 100px 20px 20px 20px;
            min-height: 100vh;
        }

        /* Phần Tiêu Đề Các Phần */
        .section-title {
            width: 100%;
            max-width: 800px;
            background-color: var(--section-title-bg);
            color: var(--section-title-color);
            padding: var(--section-title-padding);
            border-radius: var(--section-title-border-radius);
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.1em;
            font-family: var(--qa-question-font);
            font-weight: normal;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Phần 1: Khẩu Hiệu */
        .slogan-section {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--fixed-slogan-width);
            height: var(--fixed-slogan-height);
            background: var(--slogan-bg-color);
            padding: var(--slogan-padding);
            border-radius: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: width 0.3s ease;
            z-index: 1000;
        }

        #slogan {
            font-family: var(--slogan-font);
            font-size: var(--slogan-font-size);
            color: var(--slogan-color);
            opacity: 0;
            transition: var(--slogan-transition);
            text-align: center;
            word-wrap: break-word;
            font-weight: normal;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .slogan-section.active #slogan {
            opacity: 1;
        }

        /* Phần 2: Nhận Diện Biển Báo Giao Thông */
        .recognition-section {
            width: 100%;
            max-width: 800px;
            background-color: var(--white-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin-bottom: 30px;
        }

        .recognition-section h2 {
            color: var(--section-title-color);
            margin-bottom: 20px;
            font-size: 1.1em;
            text-align: center;
            font-family: var(--qa-question-font);
            font-weight: normal;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 600px;
        }

        /* Placeholder Image Styles */
        #placeholderImage {
            width: 100%;
            max-width: 600px;
            height: auto;
            border: 4px solid var(--primary-color);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            object-fit: cover;
            display: block;
        }

        /* Video Styles */
        #video, #capturedImage {
            border: 4px solid var(--primary-color);
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            height: auto;
            max-height: 400px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: opacity 0.5s ease, transform 0.3s ease;
            object-fit: cover;
        }

        #video {
            display: none;
        }

        #capturedImage {
            display: none;
            opacity: 0;
            position: relative;
        }

        /* Cải thiện thiết kế Overlay */
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60%;
            height: 60%;
            transform: translate(-50%, -50%);
            border: 3px solid rgba(40, 167, 69, 0.8);
            border-radius: 20px;
            box-sizing: border-box;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
        }

        button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            flex: 1 1 160px;
            max-width: 220px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: #ffffff;
            text-align: center;
            min-height: 44px;
        }

        /* Các màu sắc cho các nút */
        #instructionButton {
            background-color: var(--accent-color);
        }

        #captureButton {
            background-color: var(--primary-color);
        }

        #uploadButton {
            background-color: var(--secondary-color);
        }

        #downloadButton {
            background-color: var(--secondary-color);
            display: none;
        }

        #readButton {
            background-color: var(--accent-color);
            display: none;
        }

        #retakeButton {
            background-color: var(--warning-color);
            display: none;
            color: var(--dark-color);
        }

        #quizButton {
            background-color: var(--purple-color);
            display: none;
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.05);
        }

        button:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        button:focus {
            outline: 3px solid var(--focus-outline);
            outline-offset: 2px;
        }

        @media (max-width: 600px) {
            .slogan-section {
                width: 100%;
                height: var(--fixed-slogan-height);
                padding: 10px;
            }

            body {
                padding: 120px 10px 10px 10px;
            }

            button {
                width: 100%;
                max-width: 220px;
            }

            #slogan {
                font-size: 1em;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .section-title {
                font-size: 1.1em;
            }

            .recognition-section h2 {
                font-size: 1.1em;
            }

            .learning-section h2 {
                font-size: 1.1em;
            }

            .qa-section h2 {
                font-size: 1.1em;
            }
        }

        #predictionResult {
            margin-top: 20px;
            font-size: 16px;
            font-weight: bold;
            color: var(--dark-color);
            min-height: 50px;
            text-align: center;
            width: 100%;
        }

        #predictionResult p {
            margin-bottom: 10px;
        }

        #signMeaning {
            display: none;
            margin-top: 10px;
            font-size: 16px;
            color: var(--text-color);
            text-align: left;
            max-width: 600px;
            width: 100%;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            line-height: 1.6;
            font-family: var(--qa-answer-font);
        }

        #signMeaning p {
            margin-bottom: 10px;
        }

        /* Loading Spinner Styles */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingModel, #loadingPrediction {
            margin-top: 20px;
            font-size: 18px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Phần 4: Hỏi Đáp (QA) */
        .qa-section {
            width: 100%;
            max-width: 800px;
            background-color: var(--white-bg);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
        }

        .qa-section h2 {
            color: var(--section-title-color);
            margin-bottom: 20px;
            font-size: 1.1em;
            text-align: center;
            font-family: var(--qa-question-font);
            font-weight: normal;
        }

        .accordion {
            background-color: var(--white-bg);
            color: var(--question-color);
            cursor: pointer;
            padding: 20px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.1em;
            font-weight: 700;
            transition: background-color 0.3s ease;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: var(--qa-question-font);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .accordion:hover {
            background-color: var(--accordion-hover);
        }

        .accordion.active {
            background-color: var(--accordion-active);
        }

        .accordion::after {
            content: '\002B';
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .accordion.active::after {
            content: '\2212';
        }

        .panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background-color: var(--white-bg);
            border-left: 3px solid var(--primary-color);
            border-right: 3px solid var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            border-radius: 0 0 5px 5px;
            margin-bottom: 15px;
        }

        .panel.show {
            max-height: 500px;
        }

        .panel p {
            padding: 10px 15px;
            color: var(--text-color);
            font-family: var(--qa-answer-font);
            line-height: 1.6;
        }

        .panel ul {
            list-style-type: disc;
            padding-left: 30px;
            font-family: var(--qa-answer-font);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--modal-bg-color);
        }

        .modal-content {
            background-color: var(--modal-content-bg);
            margin: 5% auto;
            padding: var(--modal-padding);
            border: 2px solid var(--modal-content-border);
            width: 80%;
            border-radius: var(--modal-border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            color: var(--modal-title-color);
            margin-bottom: 15px;
            font-size: 1.8em;
            text-align: center;
        }

        .modal-content ol {
            text-align: left;
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            padding-left: 20px;
            font-size: 1em;
            color: var(--modal-text-color);
            list-style-position: inside;
            font-family: var(--qa-answer-font);
        }

        .modal-content li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .modal-content p {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            color: var(--error-color);
        }

        /* Phần 6: Footer */
        .footer {
            width: 100%;
            text-align: center;
            padding: 20px;
            font-size: 14px;
            color: var(--footer-text-color);
            background-color: var(--footer-bg-color);
            border-radius: 10px;
            position: relative;
            margin-top: 30px;
        }

        /* Nút "Làm Bài Kiểm Tra" */
        #quizButton-container {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        /* Phần 3: Tìm hiểu */
        .learning-section {
            width: 100%;
            max-width: 800px;
            background-color: var(--white-bg);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
        }

        .learning-section h2 {
            color: var(--section-title-color);
            margin-bottom: 20px;
            font-size: 1.1em;
            text-align: center;
            font-family: var(--qa-question-font);
            font-weight: normal;
        }

        .learning-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .learning-item {
            background-color: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            flex: 1 1 calc(50% - 30px);
            text-align: left;
            font-size: 1em;
            font-weight: bold;
            color: var(--text-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .learning-item:hover {
            background-color: var(--card-hover-bg);
            transform: translateY(-5px);
        }

        .learning-item:focus {
            outline: 3px solid var(--focus-outline);
        }

        /* Điều chỉnh cho thiết bị nhỏ */
        @media (max-width: 600px) {
            .learning-item {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>

    <!-- Phần 1: Khẩu Hiệu Tham Gia Giao Thông -->
    <div class="slogan-section active">
        <p id="slogan">Đi bộ trên vỉa hè - An toàn cho bạn và mọi người!</p>
    </div>

    <!-- Phần 2: Nhận Diện Biển Báo Giao Thông -->
    <div class="recognition-section">
        <h2 class="section-title">Nhận Diện Biển Báo Giao Thông</h2>
        <div class="video-container">
            <!-- Placeholder Image -->
            <img id="placeholderImage" src="https://duan-khkt2024.github.io/bienbaogiaothong/model/h1.jpg" alt="Ứng dụng Nhận Diện Biển Báo Giao Thông">
            <!-- Video Element -->
            <video id="video" autoplay playsinline aria-label="Video từ camera"></video>
            <div class="overlay"></div>
        </div>
        <img id="capturedImage" alt="Ảnh đã chụp">
        <canvas id="canvas" style="display: none;"></canvas>

        <div class="button-container">
            <button id="instructionButton" aria-label="Hướng Dẫn">Hướng Dẫn</button>
            <button id="captureButton" aria-label="Chụp ảnh">Bắt Đầu</button>
            <button id="uploadButton" aria-label="Tải ảnh lên">Tải Ảnh Lên</button>
            <button id="downloadButton" aria-label="Tải ảnh xuống">Tải Ảnh Xuống</button>
            <button id="readButton" aria-label="Đọc ý nghĩa biển báo">Đọc</button>
            <button id="retakeButton" aria-label="Chụp lại">Chụp Lại</button>
        </div>

        <!-- Hidden file input for uploading images -->
        <input type="file" id="uploadInput" accept="image/*" style="display: none;" />

        <div id="loadingModel">
            Đang tải mô hình...
            <div class="spinner"></div>
        </div>
        <div id="loadingPrediction" style="display: none;">
            Đang nhận diện...
            <div class="spinner"></div>
        </div>
        <div id="predictionResult" aria-live="polite"></div>
        <div id="signMeaning" aria-live="polite"></div>

        <!-- Nút "Làm Bài Kiểm Tra" -->
        <div id="quizButton-container">
            <button id="quizButton" aria-label="Làm bài kiểm tra" title="Làm bài kiểm tra giao thông">Làm Bài Kiểm Tra</button>
        </div>
    </div>

    <!-- Phần 3: Tìm hiểu -->
    <div class="learning-section">
        <h2 class="section-title">Tìm hiểu</h2>
        <div class="learning-items">
            <div class="learning-item" onclick="window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank')" tabindex="0" role="button" aria-label="Tìm hiểu luật giao thông cho học sinh">
                1. Tìm hiểu luật giao thông cho học sinh
            </div>
            <div class="learning-item" onclick="window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank')" tabindex="0" role="button" aria-label="Tìm hiểu về những hành vi học sinh không được làm khi tham gia giao thông">
                2. Tìm hiểu về những hành vi học sinh không được làm khi tham gia giao thông
            </div>
            <div class="learning-item" onclick="window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank')" tabindex="0" role="button" aria-label="Tìm hiểu về những tình huống thực tế">
                3. Tìm hiểu về những tình huống thực tế
            </div>
            <div class="learning-item" onclick="window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank')" tabindex="0" role="button" aria-label="Làm các bài trắc nghiệm về giao thông">
                4. Làm các bài trắc nghiệm về giao thông
            </div>
        </div>
    </div>

    <!-- Phần 4: Hỏi Đáp (QA) -->
    <div class="qa-section">
        <h2 class="section-title">Hỏi Đáp</h2>
        <div id="qa-container">
            <!-- Nội dung Hỏi Đáp sẽ được thêm vào đây bằng JavaScript -->
        </div>
    </div>

    <!-- Footer với nền xanh và chữ trắng -->
    <div class="footer">
        &copy; 2024 Ứng dụng AI nhận diện biển báo và tìm hiểu Luật giao thông đường bộ cho Học Sinh THCS
    </div>

    <!-- Modal Hướng Dẫn -->
    <div id="instructionModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="instructionModalTitle" aria-describedby="instructionModalDescription">
        <div class="modal-content">
            <span class="close-button" aria-label="Đóng">&times;</span>
            <h2 id="instructionModalTitle">Hướng Dẫn Sử Dụng</h2>
            <div id="instructionModalDescription">
                <ol>
                    <li>Nhấn nút <strong>"Bắt Đầu"</strong> để khởi động camera.</li>
                    <li>Khi camera đã khởi động, nhấn nút <strong>"Chụp Ảnh"</strong> để bắt đầu quá trình chụp hình biển báo giao thông.</li>
                    <li>Đảm bảo camera của bạn được đặt sao cho biển báo rõ ràng và trung tâm trong khung hình.</li>
                    <li>Sau khi chụp, hệ thống sẽ tự động nhận diện biển báo và hiển thị kết quả.</li>
                    <li>Nhấn nút <strong>"Đọc"</strong> để nghe lại ý nghĩa của biển báo đã nhận diện.</li>
                    <li>Chọn nút <strong>"Làm Bài Kiểm Tra"</strong> để thực hiện bài kiểm tra giao thông.</li>
                </ol>
                <p>Số lượng biển báo có thể nhận diện: <strong id="totalSigns">0</strong></p>
            </div>
        </div>
    </div>

    <!-- Thêm TensorFlow.js và các mô hình cần thiết -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <!-- JavaScript -->
    <script>
        // Các phần tử DOM
        const video = document.getElementById('video');
        const placeholderImage = document.getElementById('placeholderImage');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const uploadButton = document.getElementById('uploadButton');
        const uploadInput = document.getElementById('uploadInput');
        const downloadButton = document.getElementById('downloadButton');
        const readButton = document.getElementById('readButton');
        const retakeButton = document.getElementById('retakeButton');
        const capturedImage = document.getElementById('capturedImage');
        const predictionResult = document.getElementById('predictionResult');
        const signMeaning = document.getElementById('signMeaning');
        const loadingModel = document.getElementById('loadingModel');
        const loadingPrediction = document.getElementById('loadingPrediction');
        const signCount = document.getElementById('totalSigns');
        const quizButton = document.getElementById('quizButton');
        const overlay = document.querySelector('.overlay');
        let stream = null;
        let isProcessing = false;
        let cameraStarted = false;
        const MODEL_URL = "https://duan-khkt2024.github.io/bienbaogiaothong/model/";
        let model;
        let labels = [];

        let signMeanings = {};
        let qaData = [];

        // Thêm biến cho mô hình phát hiện đối tượng
        let detectionModel;

        // Hàm tải mô hình COCO-SSD
        async function loadDetectionModel() {
            try {
                detectionModel = await cocoSsd.load();
                console.log("Đã tải thành công mô hình phát hiện đối tượng.");
            } catch (err) {
                console.error("Lỗi khi tải mô hình phát hiện đối tượng:", err);
            }
        }

        // Hàm tải signMeanings.json
        async function loadSignMeanings() {
            try {
                const response = await fetch(MODEL_URL + "signMeanings.json");
                if (response.ok) {
                    signMeanings = await response.json();
                    console.log("Đã tải thành công signMeanings.json");
                } else {
                    console.warn("Không thể tải signMeanings.json.");
                }
            } catch (error) {
                console.error("Lỗi khi tải signMeanings.json:", error);
            }
        }

        // Hàm tải qa.json
        async function loadQA() {
            try {
                const response = await fetch(MODEL_URL + "qa.json");
                if (response.ok) {
                    const data = await response.json();
                    qaData = data.questions;
                    console.log("Đã tải thành công qa.json");
                    buildQA();
                } else {
                    console.warn("Không thể tải qa.json.");
                }
            } catch (error) {
                console.error("Lỗi khi tải qa.json:", error);
            }
        }

        // Hàm xây dựng phần Hỏi Đáp
        function buildQA() {
            const qaContainer = document.getElementById('qa-container');
            qaContainer.innerHTML = '';

            qaData.forEach((item, index) => {
                // Tạo nút accordion
                const accordionButton = document.createElement('button');
                accordionButton.classList.add('accordion');
                accordionButton.setAttribute('aria-expanded', 'false');
                accordionButton.setAttribute('aria-controls', `qa-panel-${index}`);
                accordionButton.textContent = item.question;

                // Tạo panel
                const panelDiv = document.createElement('div');
                panelDiv.classList.add('panel');
                panelDiv.id = `qa-panel-${index}`;

                // Tạo phần nội dung câu trả lời
                const answerPara = document.createElement('p');
                answerPara.textContent = item.answer;

                // Tạo danh sách các điểm
                const pointsList = document.createElement('ul');
                item.points.forEach(point => {
                    const listItem = document.createElement('li');
                    listItem.textContent = point;
                    pointsList.appendChild(listItem);
                });

                panelDiv.appendChild(answerPara);
                panelDiv.appendChild(pointsList);

                // Thêm vào container
                qaContainer.appendChild(accordionButton);
                qaContainer.appendChild(panelDiv);
            });

            // Thêm event listeners cho các nút accordion vừa tạo
            document.querySelectorAll('.accordion').forEach(button => {
                button.addEventListener('click', function() {
                    const isActive = this.classList.contains('active');
                    this.setAttribute('aria-expanded', !isActive);
                    this.classList.toggle('active');
                    const panel = this.nextElementSibling;
                    if (panel.classList.contains('show')) {
                        panel.classList.remove('show');
                        panel.style.maxHeight = null;
                    } else {
                        panel.classList.add('show');
                        panel.style.maxHeight = panel.scrollHeight + "px";
                    }
                });
            });
        }

        // Hàm khởi động camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                    },
                    audio: false
                });
                video.srcObject = stream;
                return new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                    video.onerror = (err) => {
                        reject(err);
                    };
                });
            } catch (err) {
                console.error("Không thể truy cập camera: ", err);
                alert("Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc thiết bị của bạn.");
            }
        }

        // Hàm kiểm tra độ mờ của hình ảnh
        async function checkImageBlurriness(canvasElement) {
            return new Promise((resolve) => {
                const ctx = canvasElement.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const data = imageData.data;

                let gray = [];
                for (let i = 0; i < data.length; i += 4) {
                    const avg = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    gray.push(avg);
                }

                let laplacian = [];
                const width = canvasElement.width;
                const height = canvasElement.height;
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = y * width + x;
                        const val = gray[idx - width - 1] + gray[idx - width] + gray[idx - width + 1]
                                  + gray[idx - 1] - 8 * gray[idx] + gray[idx + 1]
                                  + gray[idx + width - 1] + gray[idx + width] + gray[idx + width + 1];
                        laplacian.push(val);
                    }
                }

                const mean = laplacian.reduce((sum, val) => sum + val, 0) / laplacian.length;
                const variance = laplacian.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / laplacian.length;

                resolve(variance);
            });
        }

        // Hàm chụp ảnh từ video
        async function capturePhoto() {
            if (isProcessing) return;
            isProcessing = true;
            captureButton.disabled = true;

            if (!cameraStarted) {
                try {
                    placeholderImage.style.display = 'none';
                    video.style.display = 'block';
                    overlay.style.display = 'block';

                    await startCamera();
                    cameraStarted = true;
                    captureButton.textContent = "Chụp Ảnh";
                } catch (err) {
                    console.error("Lỗi khi khởi động camera: ", err);
                    alert("Không thể khởi động camera.");
                } finally {
                    isProcessing = false;
                    captureButton.disabled = false;
                }
            } else {
                loadingPrediction.style.display = 'flex';

                try {
                    if (video.readyState < 3) {
                        await new Promise((resolve) => {
                            video.oncanplay = () => {
                                resolve();
                            };
                        });
                    }

                    const context = canvas.getContext('2d');

                    context.imageSmoothingEnabled = true;
                    context.imageSmoothingQuality = 'high';

                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;

                    if (videoWidth === 0 || videoHeight === 0) {
                        throw new Error("Video chưa sẵn sàng.");
                    }

                    const overlayWidth = videoWidth * 0.6;
                    const overlayHeight = videoHeight * 0.6;
                    const sx = (videoWidth - overlayWidth) / 2;
                    const sy = (videoHeight - overlayHeight) / 2;

                    canvas.width = overlayWidth;
                    canvas.height = overlayHeight;

                    context.drawImage(video, sx, sy, overlayWidth, overlayHeight, 0, 0, overlayWidth, overlayHeight);

                    const variance = await checkImageBlurriness(canvas);
                    const blurThreshold = 100;
                    if (variance < blurThreshold) {
                        alert("Ảnh bị mờ. Vui lòng chụp lại với ánh sáng tốt và giữ điện thoại ổn định.");
                        throw new Error("Ảnh bị mờ.");
                    }

                    const imageDataURL = canvas.toDataURL('image/png');
                    capturedImage.src = imageDataURL;
                    capturedImage.style.display = 'block';
                    capturedImage.style.opacity = 1;
                    video.style.display = 'none';
                    overlay.style.display = 'none';
                    downloadButton.style.display = 'inline-block';
                    retakeButton.style.display = 'inline-block';
                    predictionResult.innerHTML = "";
                    signMeaning.textContent = "";
                    signMeaning.style.display = 'none';
                    readButton.style.display = 'none';
                    quizButton.style.display = 'none';

                    await predictImage();
                } catch (error) {
                    console.error("Lỗi khi chụp ảnh: ", error);
                    if (error.message !== "Ảnh bị mờ.") {
                        alert("Đã xảy ra lỗi khi chụp ảnh. Vui lòng thử lại.");
                    }
                } finally {
                    isProcessing = false;
                    captureButton.disabled = false;
                }
            }
        }

        // Hàm tải ảnh xuống
        function downloadPhoto() {
            if (!capturedImage.src) {
                alert("Không có ảnh nào để tải xuống.");
                return;
            }
            const link = document.createElement('a');
            link.href = capturedImage.src;
            link.download = 'anh-chup.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Hàm chụp lại ảnh
        function retakePhoto() {
            capturedImage.style.display = 'none';
            capturedImage.style.opacity = 0;
            downloadButton.style.display = 'none';
            readButton.style.display = 'none';
            retakeButton.style.display = 'none';
            captureButton.style.display = 'inline-block';
            captureButton.textContent = "Bắt Đầu";

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            cameraStarted = false;

            placeholderImage.style.display = 'block';
            video.style.display = 'none';
            overlay.style.display = 'none';
            predictionResult.innerHTML = "";
            signMeaning.textContent = "";
            signMeaning.style.display = 'none';
        }

        // Hàm đọc văn bản bằng giọng nói
        function speakText(text) {
            if (!('speechSynthesis' in window)) {
                console.warn('Trình duyệt của bạn không hỗ trợ Speech Synthesis.');
                return;
            }

            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance(text);
            const voices = synth.getVoices();
            const vietnameseVoices = voices.filter(voice => voice.lang.startsWith('vi'));

            if (vietnameseVoices.length > 0) {
                utterThis.voice = vietnameseVoices[0];
            }

            synth.speak(utterThis);
        }

        // Hàm tải mô hình
        async function loadModel() {
            try {
                model = await tf.loadLayersModel(MODEL_URL + "model.json");
                loadingModel.style.display = 'none';

                const response = await fetch(MODEL_URL + "metadata.json");
                if (response.ok) {
                    const metadata = await response.json();
                    if (metadata.labels && Array.isArray(metadata.labels)) {
                        labels = metadata.labels;
                        signCount.textContent = labels.length;
                        window.labels = labels;
                    } else {
                        console.warn("metadata.json không chứa trường 'labels' hoặc không phải là một mảng.");
                        window.labels = ["P.101", "W.208", "W.205", "W.207", "P.103"];
                        signCount.textContent = window.labels.length;
                    }
                } else {
                    console.warn("Không thể tải metadata.json.");
                    window.labels = ["P.101", "W.208", "W.205", "W.207", "P.103"];
                    signCount.textContent = window.labels.length;
                }

                await loadSignMeanings();
                await loadQA();
                await loadDetectionModel();

            } catch (err) {
                console.error("Lỗi khi tải mô hình: ", err);
                loadingModel.textContent = "Không thể tải mô hình.";
            }
        }

        // Hàm vẽ bounding box lên ảnh
        function drawBoundingBoxes(detectedObjects, imageElement) {
            const canvasOverlay = document.createElement('canvas');
            canvasOverlay.width = imageElement.width;
            canvasOverlay.height = imageElement.height;
            canvasOverlay.style.position = 'absolute';
            canvasOverlay.style.top = imageElement.offsetTop + 'px';
            canvasOverlay.style.left = imageElement.offsetLeft + 'px';
            canvasOverlay.style.pointerEvents = 'none';

            const ctx = canvasOverlay.getContext('2d');

            detectedObjects.forEach(obj => {
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.font = '16px Arial';
                ctx.fillStyle = 'red';

                const [x, y, width, height] = obj.bbox;

                ctx.strokeRect(x, y, width, height);
                ctx.fillText(`${obj.class} (${(obj.score * 100).toFixed(1)}%)`, x, y > 20 ? y - 5 : y + 15);
            });

            imageElement.parentNode.appendChild(canvasOverlay);
        }

        // Hàm dự đoán hình ảnh
        async function predictImage() {
            if (!model) {
                predictionResult.textContent = "Mô hình chưa được tải. Vui lòng thử lại sau.";
                loadingPrediction.style.display = 'none';
                return;
            }

            if (!detectionModel) {
                predictionResult.textContent = "Mô hình phát hiện đối tượng chưa được tải. Vui lòng thử lại sau.";
                loadingPrediction.style.display = 'none';
                return;
            }

            if (Object.keys(signMeanings).length === 0) {
                predictionResult.textContent = "Không có dữ liệu ý nghĩa biển báo. Vui lòng thử lại sau.";
                loadingPrediction.style.display = 'none';
                return;
            }

            try {
                const img = tf.browser.fromPixels(capturedImage);
                const predictions = await detectionModel.detect(capturedImage);

                const detectedObjects = predictions.filter(pred => pred.score > 0.5);

                if (detectedObjects.length === 0) {
                    predictionResult.innerHTML = `<span style="color: var(--error-color);">Không phát hiện biển báo giao thông nào.</span>`;
                    loadingPrediction.style.display = 'none';
                    return;
                }

                predictionResult.innerHTML = "";
                signMeaning.innerHTML = "";

                for (let i = 0; i < detectedObjects.length; i++) {
                    const obj = detectedObjects[i];
                    const [x, y, width, height] = obj.bbox;

                    // Điều chỉnh tỷ lệ bbox theo kích thước thực tế của ảnh
                    const scaleX = capturedImage.width / capturedImage.naturalWidth;
                    const scaleY = capturedImage.height / capturedImage.naturalHeight;

                    const adjustedX = x / scaleX;
                    const adjustedY = y / scaleY;
                    const adjustedWidth = width / scaleX;
                    const adjustedHeight = height / scaleY;

                    // Cắt vùng ảnh của đối tượng
                    const croppedImageTensor = tf.image.cropAndResize(
                        img.expandDims(0),
                        [[adjustedY / img.shape[0], adjustedX / img.shape[1], (adjustedY + adjustedHeight) / img.shape[0], (adjustedX + adjustedWidth) / img.shape[1]]],
                        [0],
                        [224, 224]
                    );

                    // Chuẩn hóa ảnh
                    const normalized = croppedImageTensor.div(255.0);

                    // Dự đoán lớp biển báo
                    const predictions = model.predict(normalized);
                    const data = predictions.dataSync();

                    // Tìm lớp có xác suất cao nhất
                    let maxProb = -1;
                    let maxIndex = -1;
                    for (let j = 0; j < data.length; j++) {
                        if (data[j] > maxProb) {
                            maxProb = data[j];
                            maxIndex = j;
                        }
                    }

                    if (maxIndex !== -1 && window.labels) {
                        const predictedClass = window.labels[maxIndex];
                        predictionResult.innerHTML += `<p>Biển báo: ${predictedClass} (${(maxProb * 100).toFixed(2)}%)</p>`;
                        const signCode = predictedClass.substring(0, 5).toUpperCase();
                        if (signMeanings.hasOwnProperty(signCode)) {
                            const meaningText = `Ý nghĩa: ${signMeanings[signCode]}`;
                            signMeaning.innerHTML += `<p>${meaningText}</p>`;
                        } else {
                            signMeaning.innerHTML += `<p>Ý nghĩa: Không tìm thấy ý nghĩa của biển báo ${predictedClass}.</p>`;
                        }
                    }

                    // Giải phóng bộ nhớ
                    croppedImageTensor.dispose();
                    normalized.dispose();
                    predictions.dispose();
                }

                signMeaning.style.display = 'block';
                readButton.style.display = 'inline-block';
                quizButton.style.display = 'inline-block';

                // Vẽ bounding boxes lên ảnh
                drawBoundingBoxes(detectedObjects, capturedImage);

            } catch (err) {
                console.error("Lỗi khi nhận diện hình ảnh: ", err);
                predictionResult.innerHTML = `<span style="color: var(--error-color);">Lỗi khi nhận diện hình ảnh.</span>`;
                signMeaning.textContent = "";
                signMeaning.style.display = 'none';
                readButton.style.display = 'none';
                quizButton.style.display = 'none';
            } finally {
                loadingPrediction.style.display = 'none';
                tf.disposeVariables();
            }
        }

        // Event listener cho nút "Đọc"
        readButton.addEventListener('click', () => {
            const text = signMeaning.textContent.replace(/^Ý nghĩa: /, "");
            if (text) {
                speakText(text);
            }
        });

        // Event listener cho nút làm bài kiểm tra
        quizButton.addEventListener('click', () => {
            window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank');
        });

        // Cập nhật danh sách giọng nói
        window.speechSynthesis.onvoiceschanged = function() {
            window.speechSynthesis.getVoices();
        };

        // Khởi động ứng dụng khi trang được tải
        window.addEventListener('load', async () => {
            await loadModel();
            startSloganRotation();
        });

        // Dừng camera khi trang được đóng hoặc tải lại
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // Event listener cho nút "Chụp Ảnh"
        captureButton.addEventListener('click', capturePhoto);

        // Event listener cho nút "Chụp Lại"
        retakeButton.addEventListener('click', retakePhoto);

        // Thêm sự kiện cho nút "Tải Ảnh Xuống"
        downloadButton.addEventListener('click', downloadPhoto);

        // Event listener cho nút "Tải Ảnh Lên"
        uploadButton.addEventListener('click', () => {
            uploadInput.click();
        });

        // Event listener cho việc chọn file từ file input
        uploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    capturedImage.src = e.target.result;
                    capturedImage.style.display = 'block';
                    capturedImage.style.opacity = 1;
                    video.style.display = 'none';
                    placeholderImage.style.display = 'none';
                    overlay.style.display = 'none';
                    downloadButton.style.display = 'inline-block';
                    retakeButton.style.display = 'inline-block';
                    predictionResult.innerHTML = "";
                    signMeaning.textContent = "";
                    signMeaning.style.display = 'none';
                    readButton.style.display = 'none';
                    quizButton.style.display = 'none';

                    await predictImage();
                };
                reader.readAsDataURL(file);
            } else {
                alert("Vui lòng chọn một tệp ảnh hợp lệ.");
            }
        });

        // Hàm khởi động khẩu hiệu
        const slogans = [
            "An toàn giao thông - Hạnh phúc cho mọi nhà!",
            "Đi đúng làn đường, an toàn trên mọi nẻo đường!",
            "Đội mũ bảo hiểm - Vẹn tròn tương lai!",
            "Đi bộ trên vỉa hè - An toàn cho bạn và mọi người!",
            "Tuân thủ luật giao thông - Bảo vệ chính mình!",
            "Không phóng nhanh, vượt ẩu - An toàn là trên hết!",
            "Chậm mà chắc - Về nhà an toàn!"
        ];

        let currentSloganIndex = 0;
        const sloganElement = document.getElementById('slogan');
        const sloganSection = document.querySelector('.slogan-section');

        function showSlogan(index) {
            sloganElement.textContent = slogans[index];
            sloganSection.classList.add('active');
            setTimeout(() => {
                sloganSection.classList.remove('active');
            }, 6000);
        }

        function startSloganRotation() {
            showSlogan(currentSloganIndex);
            currentSloganIndex = (currentSloganIndex + 1) % slogans.length;
            setInterval(() => {
                showSlogan(currentSloganIndex);
                currentSloganIndex = (currentSloganIndex + 1) % slogans.length;
            }, 7000);
        }

        // Event Listener cho Modal Hướng Dẫn
        const instructionButton = document.getElementById('instructionButton');
        const instructionModal = document.getElementById('instructionModal');
        const closeButton = document.querySelector('.close-button');

        instructionButton.addEventListener('click', () => {
            instructionModal.style.display = 'block';
            instructionModal.setAttribute('aria-hidden', 'false');
        });

        closeButton.addEventListener('click', () => {
            instructionModal.style.display = 'none';
            instructionModal.setAttribute('aria-hidden', 'true');
        });

        window.addEventListener('click', (event) => {
            if (event.target == instructionModal) {
                instructionModal.style.display = 'none';
                instructionModal.setAttribute('aria-hidden', 'true');
            }
        });
    </script>

</body>
</html>
