<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Nhận Diện Biển Báo Giao Thông</title>
    <style>
        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; /* Để overlay nằm trên video */
        }

        /* Điều chỉnh chiều cao video cho thiết bị di động */
        #webcam-container, #capturedImage {
            border: 4px solid #4CAF50;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            height: auto;
            max-height: 400px; /* Giảm chiều cao tối đa */
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: opacity 0.5s ease, transform 0.3s ease;
            object-fit: cover;
            position: relative;
        }

        #capturedImage {
            display: none;
            opacity: 0;
        }

        /* Overlay để tạo khung mờ */
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%; /* Thu nhỏ từ 80% xuống 70% */
            height: 70%; /* Thu nhỏ từ 80% xuống 70% */
            transform: translate(-50%, -50%);
            border: 4px dashed rgba(76, 175, 80, 0.7);
            background-color: rgba(0, 0, 0, 0.2); /* Màu mờ */
            pointer-events: none; /* Không can thiệp vào các sự kiện */
            border-radius: 15px;
            display: none; /* Ẩn mặc định */
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
        }

        button, select {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            min-width: 160px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: #fff;
        }

        button {
            background-color: #28a745;
        }

        #startCameraButton {
            background-color: #17a2b8;
        }

        #downloadButton {
            background-color: #007bff;
            display: none;
        }

        #retakeButton {
            background-color: #ffc107;
            display: none;
            color: #333;
        }

        #speakButton {
            background-color: #17a2b8;
            display: none;
            margin-top: 10px;
        }

        button:hover:not(:disabled), select:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.05);
        }

        button:disabled, select:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        @media (max-width: 600px) {
            .zoom-container {
                flex-direction: column;
                align-items: stretch;
            }

            .zoom-container label,
            .zoom-container span {
                text-align: left;
                width: auto;
            }

            .zoom-container input[type="range"] {
                width: 100%;
            }

            button, select {
                width: 100%;
                max-width: 220px;
            }
        }

        #predictionResult {
            margin-top: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            min-height: 50px;
            text-align: center;
        }

        #signMeaning {
            margin-top: 10px;
            font-size: 16px;
            color: #555;
            text-align: center;
            max-width: 600px;
            position: relative;
        }

        /* Khung mờ cho ý nghĩa biển báo */
        #signMeaning::before {
            content: "";
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1); /* Màu mờ */
            backdrop-filter: blur(5px); /* Hiệu ứng mờ */
            border-radius: 8px;
            z-index: -1;
        }

        /* Loading Spinner Styles */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingModel, #loadingPrediction {
            margin-top: 20px;
            font-size: 18px;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer {
            width: 100%;
            text-align: center;
            padding-top: 20px;
            font-size: 14px;
            color: #888;
        }

        /* Zoom Control Styling */
        .zoom-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }

        .zoom-container label {
            font-size: 16px;
            color: #333;
            flex: 0 0 auto;
        }

        .zoom-container input[type="range"] {
            flex: 1 1 auto;
        }

        .zoom-container span {
            font-size: 16px;
            color: #333;
            flex: 0 0 auto;
            width: 40px;
            text-align: right;
        }

        /* Khung Mờ Cho Ý Nghĩa Biển Báo */
        .meaning-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3); /* Màu mờ */
            border-radius: 8px;
            z-index: -1;
            display: none; /* Ẩn mặc định */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Nhận Diện Biển Báo Giao Thông</h1>
        
        <!-- Nút Bắt Đầu Khởi Chạy Camera -->
        <button id="startCameraButton" aria-label="Bật Camera">Bật Camera</button>

        <!-- Chọn Camera (hiển thị khi có nhiều camera) -->
        <select id="cameraSelect" style="display: none; margin-bottom: 20px;">
            <option value="">Chọn Camera</option>
        </select>

        <div id="webcam-container" style="display: none; position: relative;">
            <canvas id="webcamCanvas" autoplay playsinline aria-label="Video từ camera"></canvas>
            <div class="overlay"></div>
        </div>
        <img id="capturedImage" alt="Ảnh đã chụp">
        <canvas id="canvas" style="display: none;"></canvas>

        <div class="zoom-container">
            <label for="zoomSlider">Zoom:</label>
            <input type="range" id="zoomSlider" min="1" max="3" step="0.1" value="1">
            <span id="zoomValue">1x</span>
        </div>

        <div class="button-container">
            <button id="captureButton" aria-label="Chụp ảnh" disabled>Chụp Ảnh</button>
            <button id="downloadButton" aria-label="Tải ảnh xuống">Tải Ảnh Xuống</button>
            <button id="retakeButton" aria-label="Chụp lại">Chụp Lại</button>
        </div>

        <div id="loadingModel">
            Đang tải mô hình...
            <div class="spinner"></div>
        </div>
        <div id="loadingPrediction" style="display: none;">
            Đang nhận diện...
            <div class="spinner"></div>
        </div>
        <div id="predictionResult" aria-live="polite">Kết quả nhận diện sẽ hiển thị ở đây.</div>
        <div id="signMeaning" aria-live="polite">
            <!-- Khung mờ cho ý nghĩa -->
            <div class="meaning-overlay"></div>
        </div>
        <!-- Nút để nghe lại ý nghĩa biển báo -->
        <button id="speakButton" aria-label="Nghe lại ý nghĩa biển báo">Nghe Lại</button>
    </div>

    <div class="footer">
        &copy; 2024 Ứng dụng Nhận Diện Biển Báo Giao Thông
    </div>

    <!-- TensorFlow.js và Teachable Machine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script>
        // Các phần tử từ DOM
        const startCameraButton = document.getElementById('startCameraButton');
        const cameraSelect = document.getElementById('cameraSelect');
        const webcamContainer = document.getElementById('webcam-container');
        const webcamCanvas = document.getElementById('webcamCanvas');
        const captureButton = document.getElementById('captureButton');
        const downloadButton = document.getElementById('downloadButton');
        const retakeButton = document.getElementById('retakeButton');
        const capturedImage = document.getElementById('capturedImage');
        const predictionResult = document.getElementById('predictionResult');
        const signMeaning = document.getElementById('signMeaning');
        const loadingModel = document.getElementById('loadingModel');
        const loadingPrediction = document.getElementById('loadingPrediction');
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        const speakButton = document.getElementById('speakButton');
        const meaningOverlay = document.querySelector('.meaning-overlay');

        let model, maxPredictions;
        let webcam = null;
        let currentDeviceId = null;
        let isProcessing = false; // Flag để ngăn chặn nhiều lần xử lý đồng thời

        // Thông tin mô hình Teachable Machine
        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/7y8Dc7os8/";

        // Bản đồ mã biển báo và ý nghĩa tương ứng
        const signMeanings = {
            "P.101": "Để báo trước nơi giao nhau có điều khiển giao thông bằng tín hiệu đèn trong trường hợp người tham gia giao thông khó quan sát thấy đèn để kịp thời xử lý.",
            "W.208": "Các xe đi trên đường có đặt biển số W.208 phải nhường đường cho xe đi trên đường ưu tiên khi qua nơi giao nhau (trừ các loại xe được quyền ưu tiên theo quy định).",
            // Thêm các mã biển báo khác ở đây
            // "Code": "Ý nghĩa..."
        };

        /**
         * Hàm để nói văn bản tiếng Việt
         * @param {string} text - Văn bản cần nói
         */
        function speakText(text) {
            if (!('speechSynthesis' in window)) {
                console.warn('Trình duyệt của bạn không hỗ trợ Speech Synthesis.');
                return;
            }

            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance(text);

            // Lấy danh sách giọng nói
            const voices = synth.getVoices();

            // Chọn giọng nói tiếng Việt
            const vietnameseVoices = voices.filter(voice => voice.lang.startsWith('vi'));

            if (vietnameseVoices.length > 0) {
                utterThis.voice = vietnameseVoices[0];
            } else {
                console.warn('Không tìm thấy giọng nói tiếng Việt. Sử dụng giọng mặc định.');
            }

            synth.speak(utterThis);
        }

        /**
         * Hàm tải mô hình Teachable Machine
         */
        async function loadModel() {
            const modelURL = MODEL_URL + "model.json";
            const metadataURL = MODEL_URL + "metadata.json";

            try {
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                console.log("Mô hình đã được tải thành công.");
                loadingModel.style.display = 'none';
                captureButton.disabled = false;
            } catch (err) {
                console.error("Lỗi khi tải mô hình: ", err);
                alert("Không thể tải mô hình nhận diện. Vui lòng kiểm tra kết nối mạng hoặc URL mô hình.");
                loadingModel.textContent = "Không thể tải mô hình.";
            }
        }

        /**
         * Hàm liệt kê các camera có sẵn và hiển thị trong select
         */
        async function listCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                if (videoDevices.length > 1) {
                    cameraSelect.style.display = 'block';
                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Camera ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                } else {
                    cameraSelect.style.display = 'none';
                }
            } catch (err) {
                console.error("Lỗi khi liệt kê camera: ", err);
            }
        }

        /**
         * Hàm khởi chạy camera với deviceId cụ thể
         * @param {string} deviceId - ID của thiết bị camera
         */
        async function startCamera(deviceId = null) {
            try {
                webcam = new tmImage.Webcam(600, 400, true); // width, height, flip
                await webcam.setup(deviceId ? { deviceId: deviceId } : {}); // chọn camera nếu có
                await webcam.play();
                window.requestAnimationFrame(loop);

                webcamContainer.appendChild(webcam.canvas);
                webcamContainer.style.display = 'block';
                captureButton.disabled = false;
                document.getElementById('startCameraButton').style.display = 'none';
                meaningOverlay.style.display = 'block'; // Hiển thị overlay khi camera mở

                // Hiển thị overlay
                document.querySelector('.overlay').style.display = 'block';
            } catch (err) {
                console.error("Không thể truy cập camera: ", err);
                alert("Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc thiết bị của bạn.");
            }
        }

        /**
         * Hàm dừng camera
         */
        function stopCamera() {
            if (webcam) {
                webcam.stop();
                webcam = null;
            }
            webcamContainer.style.display = 'none';
            document.querySelector('.overlay').style.display = 'none'; // Ẩn overlay khi dừng camera
        }

        /**
         * Hàm nhận diện hình ảnh
         */
        async function predictImage() {
            if (!model || !webcam) {
                predictionResult.textContent = "Mô hình hoặc camera chưa sẵn sàng. Vui lòng thử lại sau.";
                loadingPrediction.style.display = 'none';
                return;
            }

            try {
                const prediction = await model.predict(webcam.canvas);
                if (prediction.length > 0) {
                    // Sắp xếp các dự đoán theo xác suất giảm dần
                    prediction.sort((a, b) => b.probability - a.probability);
                    // Lấy top prediction
                    const topPrediction = prediction[0];
                    predictionResult.innerHTML = `<span style="color: #28a745;">Kết quả: ${topPrediction.className} (${(topPrediction.probability * 100).toFixed(2)}%)</span>`;

                    // Trích xuất mã biển báo từ kết quả nhận diện
                    const signCode = topPrediction.className.substring(0, 5).toUpperCase(); // Đảm bảo mã là chữ hoa
                    if (signMeanings.hasOwnProperty(signCode)) {
                        const meaningText = `Ý nghĩa: ${signMeanings[signCode]}`;
                        signMeaning.textContent = meaningText;
                        speakButton.style.display = 'inline-block'; // Hiển thị nút nghe lại
                        speakText(meaningText); // Đọc ra ý nghĩa biển báo
                    } else {
                        signMeaning.textContent = "Ý nghĩa: Không tìm thấy ý nghĩa cho biển báo này.";
                        speakButton.style.display = 'inline-block'; // Hiển thị nút nghe lại
                        speakText("Không tìm thấy ý nghĩa cho biển báo này.");
                    }
                } else {
                    predictionResult.textContent = "Không có kết quả nhận diện.";
                    signMeaning.textContent = "";
                    speakButton.style.display = 'none'; // Ẩn nút nghe lại nếu không có kết quả
                }
            } catch (err) {
                console.error("Lỗi khi nhận diện hình ảnh: ", err);
                predictionResult.textContent = "Lỗi khi nhận diện hình ảnh.";
                signMeaning.textContent = "";
                speakButton.style.display = 'none'; // Ẩn nút nghe lại nếu có lỗi
            } finally {
                loadingPrediction.style.display = 'none';
            }
        }

        /**
         * Hàm chụp ảnh với zoom
         */
        async function capturePhoto() {
            if (isProcessing) return; // Ngăn chặn nhiều lần nhấn
            isProcessing = true;
            captureButton.disabled = true;

            try {
                loadingPrediction.style.display = 'flex';
                predictionResult.textContent = "";
                signMeaning.textContent = "";
                speakButton.style.display = 'none'; // Ẩn nút nghe lại khi chụp ảnh

                const zoom = parseFloat(zoomSlider.value);
                const videoWidth = webcam.canvas.width;
                const videoHeight = webcam.canvas.height;

                // Tính toán kích thước và vị trí cắt dựa trên zoom
                const scaledWidth = videoWidth / zoom;
                const scaledHeight = videoHeight / zoom;
                const sx = (videoWidth - scaledWidth) / 2;
                const sy = (videoHeight - scaledHeight) / 2;

                // Vẽ hình ảnh đã zoom lên canvas
                const context = canvas.getContext('2d');
                canvas.width = videoWidth;
                canvas.height = videoHeight;
                context.drawImage(webcam.canvas, sx, sy, scaledWidth, scaledHeight, 0, 0, videoWidth, videoHeight);

                const imageDataURL = canvas.toDataURL('image/png');
                capturedImage.src = imageDataURL;
                capturedImage.style.display = 'block';
                capturedImage.style.opacity = 1;
                webcamContainer.style.display = 'none';
                meaningOverlay.style.display = 'none'; // Ẩn overlay khi chụp ảnh
                downloadButton.style.display = 'inline-block';
                retakeButton.style.display = 'inline-block';
                captureButton.style.display = 'none';
                loadingPrediction.style.display = 'flex';
                await predictImage();
            } catch (error) {
                console.error("Lỗi khi chụp ảnh: ", error);
                alert("Đã xảy ra lỗi khi chụp ảnh. Vui lòng thử lại.");
            } finally {
                isProcessing = false;
                if (model && webcam) {
                    captureButton.disabled = false;
                }
            }
        }

        /**
         * Hàm tải ảnh xuống
         */
        function downloadPhoto() {
            if (!capturedImage.src) return; // Ngăn chặn tải xuống nếu không có ảnh
            const link = document.createElement('a');
            link.href = capturedImage.src;
            link.download = 'anh-chup.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Hàm chụp lại
         */
        function retakePhoto() {
            capturedImage.style.display = 'none';
            capturedImage.style.opacity = 0;
            webcamContainer.style.display = 'block';
            captureButton.style.display = 'inline-block';
            downloadButton.style.display = 'none';
            retakeButton.style.display = 'none';
            predictionResult.textContent = "Kết quả nhận diện sẽ hiển thị ở đây.";
            signMeaning.textContent = "";
            speakButton.style.display = 'none'; // Ẩn nút nghe lại khi chụp lại
            meaningOverlay.style.display = 'block'; // Hiển thị lại overlay khi chụp lại

            // Clear canvas
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
        }

        /**
         * Hàm khởi chạy vòng lặp nhận diện liên tục nếu cần
         */
        async function loop() {
            if (webcam && webcam.playing) {
                webcam.update(); // Cập nhật khung hình từ webcam
                // Có thể thêm các hành động liên tục ở đây nếu cần
            }
            window.requestAnimationFrame(loop);
        }

        /**
         * Hàm tải danh sách giọng nói khi chúng đã sẵn sàng
         */
        function populateVoices() {
            const synth = window.speechSynthesis;
            const voices = synth.getVoices();
            // Lưu trữ giọng nói tiếng Việt vào một biến global nếu cần
            window.vietnameseVoices = voices.filter(voice => voice.lang.startsWith('vi'));
        }

        // Thêm sự kiện khi danh sách giọng nói thay đổi
        window.speechSynthesis.onvoiceschanged = populateVoices;

        // Sự kiện khi nhấn nút chụp ảnh
        captureButton.addEventListener('click', capturePhoto);

        // Sự kiện khi nhấn nút tải ảnh xuống
        downloadButton.addEventListener('click', downloadPhoto);

        // Sự kiện khi nhấn nút chụp lại
        retakeButton.addEventListener('click', retakePhoto);

        // Sự kiện khi thay đổi zoom
        zoomSlider.addEventListener('input', () => {
            zoomValue.textContent = `${zoomSlider.value}x`;
        });

        // Sự kiện khi nhấn nút nghe lại ý nghĩa biển báo
        speakButton.addEventListener('click', () => {
            const text = signMeaning.textContent || "";
            if (text) {
                speakText(text);
            }
        });

        // Sự kiện khi thay đổi camera
        cameraSelect.addEventListener('change', async () => {
            const selectedDeviceId = cameraSelect.value;
            if (selectedDeviceId) {
                stopCamera();
                await startCamera(selectedDeviceId);
            }
        });

        // Sự kiện khi nhấn nút bật camera
        startCameraButton.addEventListener('click', async () => {
            await loadModel();
            await listCameras();
            const selectedDeviceId = cameraSelect.value || null;
            await startCamera(selectedDeviceId);
        });

        // Khởi chạy khi trang được tải
        window.addEventListener('load', () => {
            populateVoices(); // Lấy giọng nói ngay khi trang tải
        });

        // Dừng camera khi rời khỏi trang
        window.addEventListener('beforeunload', stopCamera);
    </script>

</body>
</html>
