<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Nhận Diện Biển Báo Giao Thông</title>
    <!-- Thêm Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <!-- Thêm Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <style>
        /* CSS Variables và các kiểu CSS khác giữ nguyên */
        :root {
            /* ... các biến CSS hiện tại ... */
        }

        /* Reset CSS */
        /* ... giữ nguyên ... */

        /* Các phần CSS hiện tại */

        /* Thêm CSS cho Cropper Modal */
        /* Modal Cắt Ảnh */
        #cropModal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1100; /* Vượt trên modal hướng dẫn */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8); /* Nền đen trong suốt */
        }

        #cropModalContent {
            background-color: var(--modal-content-bg);
            margin: 5% auto;
            padding: 20px;
            border: 2px solid var(--modal-content-border);
            width: 90%;
            max-width: 800px;
            border-radius: var(--modal-border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        #cropImage {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .crop-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .crop-buttons button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: #ffffff;
        }

        #confirmCropButton {
            background-color: var(--primary-color);
        }

        #cancelCropButton {
            background-color: var(--error-color);
        }

        /* Responsive cho Cropper Modal */
        @media (max-width: 600px) {
            #cropModalContent {
                width: 95%;
            }
        }
    </style>
</head>
<body>

    <!-- Phần 1: Khẩu Hiệu Tham Gia Giao Thông -->
    <div class="slogan-section active">
        <p id="slogan">Đi bộ trên vỉa hè - An toàn cho bạn và mọi người!</p>
    </div>

    <!-- Phần 2: Nhận Diện Biển Báo Giao Thông -->
    <div class="recognition-section">
        <h2 class="section-title">Nhận Diện Biển Báo Giao Thông</h2>
        <div class="video-container">
            <!-- Placeholder Image -->
            <img id="placeholderImage" src="https://duan-khkt2024.github.io/bienbaogiaothong/model/h1.jpg" alt="Ứng dụng Nhận Diện Biển Báo Giao Thông">
            <!-- Video Element -->
            <video id="video" autoplay playsinline aria-label="Video từ camera"></video>
            <div class="overlay"></div>
        </div>
        <img id="capturedImage" alt="Ảnh đã chụp">
        <canvas id="canvas" style="display: none;"></canvas>

        <div class="button-container">
            <button id="instructionButton" aria-label="Hướng Dẫn">Hướng Dẫn</button>
            <button id="captureButton" aria-label="Chụp ảnh">Bắt Đầu</button>
            <button id="uploadButton" aria-label="Tải ảnh lên">Tải Ảnh Lên</button>
            <button id="downloadButton" aria-label="Tải ảnh xuống">Tải Ảnh Xuống</button>
            <button id="readButton" aria-label="Đọc ý nghĩa biển báo">Đọc</button>
            <button id="retakeButton" aria-label="Chụp lại">Chụp Lại</button>
        </div>

        <!-- Hidden file input for uploading images -->
        <input type="file" id="uploadInput" accept="image/*" style="display: none;" />

        <div id="loadingModel">
            Đang tải mô hình...
            <div class="spinner"></div>
        </div>
        <div id="loadingPrediction" style="display: none;">
            Đang nhận diện...
            <div class="spinner"></div>
        </div>
        <div id="predictionResult" aria-live="polite"></div>
        <div id="signMeaning" aria-live="polite"></div>

        <!-- Nút "Làm Bài Kiểm Tra" -->
        <div id="quizButton-container">
            <button id="quizButton" aria-label="Làm bài kiểm tra" title="Làm bài kiểm tra giao thông">Làm Bài Kiểm Tra</button>
        </div>
    </div>

    <!-- Phần 3: Tìm hiểu -->
    <div class="learning-section">
        <h2 class="section-title">Tìm hiểu</h2>
        <div class="learning-items">
            <div class="learning-item" onclick="window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank')" tabindex="0" role="button" aria-label="Tìm hiểu luật giao thông cho học sinh">
                1. Tìm hiểu luật giao thông cho học sinh
            </div>
            <div class="learning-item" onclick="window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank')" tabindex="0" role="button" aria-label="Tìm hiểu về những hành vi học sinh không được làm khi tham gia giao thông">
                2. Tìm hiểu về những hành vi học sinh không được làm khi tham gia giao thông
            </div>
            <div class="learning-item" onclick="window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank')" tabindex="0" role="button" aria-label="Tìm hiểu về những tình huống thực tế">
                3. Tìm hiểu về những tình huống thực tế
            </div>
            <div class="learning-item" onclick="window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank')" tabindex="0" role="button" aria-label="Làm các bài trắc nghiệm về giao thông">
                4. Làm các bài trắc nghiệm về giao thông
            </div>
        </div>
    </div>

    <!-- Phần 4: Hỏi Đáp (QA) -->
    <div class="qa-section">
        <h2 class="section-title">Hỏi Đáp</h2>
        <div id="qa-container">
            <!-- Nội dung Hỏi Đáp sẽ được thêm vào đây bằng JavaScript -->
        </div>
    </div>

    <!-- Footer với nền xanh và chữ trắng -->
    <div class="footer">
        &copy; 2024 Ứng dụng AI nhận diện biển báo và tìm hiểu Luật giao thông đường bộ cho Học Sinh THCS
    </div>

    <!-- Modal Hướng Dẫn -->
    <div id="instructionModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="instructionModalTitle" aria-describedby="instructionModalDescription">
        <div class="modal-content">
            <span class="close-button" aria-label="Đóng">&times;</span>
            <h2 id="instructionModalTitle">Hướng Dẫn Sử Dụng</h2>
            <div id="instructionModalDescription">
                <ol>
                    <li>Nhấn nút <strong>"Bắt Đầu"</strong> để khởi động camera.</li>
                    <li>Khi camera đã khởi động, nhấn nút <strong>"Chụp Ảnh"</strong> để bắt đầu quá trình chụp hình biển báo giao thông.</li>
                    <li>Đảm bảo camera của bạn được đặt sao cho biển báo rõ ràng và trung tâm trong khung hình.</li>
                    <li>Sau khi chụp, hệ thống sẽ tự động nhận diện biển báo và hiển thị kết quả.</li>
                    <li>Nhấn nút <strong>"Đọc"</strong> để nghe lại ý nghĩa của biển báo đã nhận diện.</li>
                    <li>Chọn nút <strong>"Làm Bài Kiểm Tra"</strong> để thực hiện bài kiểm tra giao thông.</li>
                </ol>
                <p>Số lượng biển báo có thể nhận diện: <strong id="totalSigns">0</strong></p>
            </div>
        </div>
    </div>

    <!-- Modal Cắt Ảnh -->
    <div id="cropModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="cropModalTitle" aria-describedby="cropModalDescription">
        <div id="cropModalContent" class="modal-content">
            <h2 id="cropModalTitle">Chọn Vùng Cắt Ảnh</h2>
            <img id="cropImage" src="" alt="Ảnh cần cắt">
            <div class="crop-buttons">
                <button id="confirmCropButton" aria-label="Xác nhận cắt">Xác nhận</button>
                <button id="cancelCropButton" aria-label="Hủy bỏ cắt">Hủy bỏ</button>
            </div>
        </div>
    </div>

    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>

    <script>
        // Các phần tử DOM
        const video = document.getElementById('video');
        const placeholderImage = document.getElementById('placeholderImage');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const uploadButton = document.getElementById('uploadButton');
        const uploadInput = document.getElementById('uploadInput'); // Hidden file input
        const downloadButton = document.getElementById('downloadButton');
        const readButton = document.getElementById('readButton');
        const retakeButton = document.getElementById('retakeButton');
        const capturedImage = document.getElementById('capturedImage');
        const predictionResult = document.getElementById('predictionResult');
        const signMeaning = document.getElementById('signMeaning');
        const loadingModel = document.getElementById('loadingModel');
        const loadingPrediction = document.getElementById('loadingPrediction');
        const signCount = document.getElementById('totalSigns');
        const quizButton = document.getElementById('quizButton');
        const overlay = document.querySelector('.overlay');
        let stream = null;
        let isProcessing = false;
        let cameraStarted = false; // Biến trạng thái camera
        const MODEL_URL = "https://duan-khkt2024.github.io/bienbaogiaothong/model/";
        let model;
        let labels = []; // Danh sách nhãn sẽ được tải từ metadata.json

        let signMeanings = {};
        let qaData = [];

        // Cropper.js variables
        let cropper = null;
        const cropModal = document.getElementById('cropModal');
        const cropImage = document.getElementById('cropImage');
        const confirmCropButton = document.getElementById('confirmCropButton');
        const cancelCropButton = document.getElementById('cancelCropButton');

        /**
         * Hàm tải signMeanings.json
         */
        async function loadSignMeanings() {
            try {
                const response = await fetch(MODEL_URL + "signMeanings.json");
                if (response.ok) {
                    signMeanings = await response.json();
                    console.log("Đã tải thành công signMeanings.json");
                } else {
                    console.warn("Không thể tải signMeanings.json. Đang sử dụng signMeanings mặc định.");
                    // Bạn có thể định nghĩa signMeanings mặc định ở đây nếu cần
                }
            } catch (error) {
                console.error("Lỗi khi tải signMeanings.json:", error);
                // Xử lý lỗi nếu cần
            }
        }

        /**
         * Hàm tải qa.json
         */
        async function loadQA() {
            try {
                const response = await fetch(MODEL_URL + "qa.json");
                if (response.ok) {
                    const data = await response.json();
                    qaData = data.questions;
                    console.log("Đã tải thành công qa.json");
                    buildQA();
                } else {
                    console.warn("Không thể tải qa.json.");
                    // Bạn có thể định nghĩa dữ liệu QA mặc định ở đây nếu cần
                }
            } catch (error) {
                console.error("Lỗi khi tải qa.json:", error);
                // Xử lý lỗi nếu cần
            }
        }

        /**
         * Hàm xây dựng phần Hỏi Đáp
         */
        function buildQA() {
            const qaContainer = document.getElementById('qa-container');
            qaContainer.innerHTML = ''; // Xóa nội dung cũ nếu có

            qaData.forEach((item, index) => {
                // Tạo nút accordion
                const accordionButton = document.createElement('button');
                accordionButton.classList.add('accordion');
                accordionButton.setAttribute('aria-expanded', 'false');
                accordionButton.setAttribute('aria-controls', `qa-panel-${index}`);
                accordionButton.textContent = item.question;

                // Tạo panel
                const panelDiv = document.createElement('div');
                panelDiv.classList.add('panel');
                panelDiv.id = `qa-panel-${index}`;

                // Tạo phần nội dung câu trả lời
                const answerPara = document.createElement('p');
                answerPara.textContent = item.answer;

                // Tạo danh sách các điểm
                const pointsList = document.createElement('ul');
                item.points.forEach(point => {
                    const listItem = document.createElement('li');
                    listItem.textContent = point;
                    pointsList.appendChild(listItem);
                });

                panelDiv.appendChild(answerPara);
                panelDiv.appendChild(pointsList);

                // Thêm vào container
                qaContainer.appendChild(accordionButton);
                qaContainer.appendChild(panelDiv);
            });

            // Thêm event listeners cho các nút accordion vừa tạo
            document.querySelectorAll('.accordion').forEach(button => {
                button.addEventListener('click', function() {
                    const isActive = this.classList.contains('active');
                    this.setAttribute('aria-expanded', !isActive);
                    this.classList.toggle('active');
                    const panel = this.nextElementSibling;
                    if (panel.classList.contains('show')) {
                        panel.classList.remove('show');
                        panel.style.maxHeight = null;
                    } else {
                        panel.classList.add('show');
                        panel.style.maxHeight = panel.scrollHeight + "px";
                    }
                });
            });
        }

        /**
         * Hàm khởi động camera
         */
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        // Optional: thêm các constraints khác nếu cần
                    },
                    audio: false
                });
                video.srcObject = stream;
                return new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                    video.onerror = (err) => {
                        reject(err);
                    };
                });
            } catch (err) {
                console.error("Không thể truy cập camera: ", err);
                alert("Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc thiết bị của bạn.");
            }
        }

        /**
         * Hàm mở Crop Modal và khởi tạo Cropper.js
         * @param {string} imageSrc - URL của hình ảnh cần cắt
         */
        function openCropModal(imageSrc) {
            cropImage.src = imageSrc;
            cropModal.style.display = 'block';
            cropModal.setAttribute('aria-hidden', 'false');

            // Khởi tạo Cropper.js
            cropper = new Cropper(cropImage, {
                aspectRatio: 1, // Có thể thay đổi tỉ lệ tùy ý
                viewMode: 1,
                movable: true,
                zoomable: true,
                rotatable: false,
                scalable: false,
                background: false,
                guides: true,
                highlight: true,
                autoCropArea: 0.8, // Tỉ lệ vùng cắt tự động
                responsive: true,
            });
        }

        /**
         * Hàm đóng Crop Modal và hủy Cropper.js
         */
        function closeCropModal() {
            cropModal.style.display = 'none';
            cropModal.setAttribute('aria-hidden', 'true');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            cropImage.src = "";
        }

        /**
         * Hàm chụp ảnh từ video
         */
        async function capturePhoto() {
            if (isProcessing) return;
            isProcessing = true;
            captureButton.disabled = true;

            if (!cameraStarted) {
                // Nếu camera chưa được khởi động, bắt đầu camera
                try {
                    // Hide placeholder image and show video
                    placeholderImage.style.display = 'none';
                    video.style.display = 'block';
                    overlay.style.display = 'block'; // Show overlay when video is active

                    await startCamera();
                    cameraStarted = true;
                    captureButton.textContent = "Chụp Ảnh"; // Thay đổi nhãn nút sau khi camera đã khởi động
                } catch (err) {
                    console.error("Lỗi khi khởi động camera: ", err);
                    alert("Không thể khởi động camera.");
                } finally {
                    isProcessing = false;
                    captureButton.disabled = false;
                }
            } else {
                // Nếu camera đã được khởi động, tiến hành chụp ảnh
                loadingPrediction.style.display = 'flex';

                try {
                    // Kiểm tra xem video đã sẵn sàng chưa
                    if (video.readyState < 3) { // HAVE_CURRENT_DATA = 2, HAVE_FUTURE_DATA = 3
                        await new Promise((resolve) => {
                            video.oncanplay = () => {
                                resolve();
                            };
                        });
                    }

                    const context = canvas.getContext('2d');
                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;

                    if (videoWidth === 0 || videoHeight === 0) {
                        throw new Error("Video chưa sẵn sàng.");
                    }

                    // Kích thước và vị trí của overlay (60% chiều rộng và chiều cao)
                    const overlayWidth = videoWidth * 0.6;
                    const overlayHeight = videoHeight * 0.6;
                    const sx = (videoWidth - overlayWidth) / 2;
                    const sy = (videoHeight - overlayHeight) / 2;

                    // Cài đặt kích thước canvas theo kích thước overlay
                    canvas.width = overlayWidth;
                    canvas.height = overlayHeight;

                    // Vẽ phần ảnh trong khu vực overlay vào canvas
                    context.drawImage(video, sx, sy, overlayWidth, overlayHeight, 0, 0, overlayWidth, overlayHeight);

                    const imageDataURL = canvas.toDataURL('image/png');

                    // Mở Crop Modal với hình ảnh đã chụp
                    openCropModal(imageDataURL);
                } catch (error) {
                    console.error("Lỗi khi chụp ảnh: ", error);
                    alert("Đã xảy ra lỗi khi chụp ảnh. Vui lòng thử lại.");
                } finally {
                    isProcessing = false;
                    captureButton.disabled = false;
                }
            }
        }

        /**
         * Hàm tải ảnh xuống
         */
        function downloadPhoto() {
            if (!capturedImage.src) {
                alert("Không có ảnh nào để tải xuống.");
                return;
            }
            const link = document.createElement('a');
            link.href = capturedImage.src;
            link.download = 'anh-chup.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Hàm chụp lại ảnh
         */
        function retakePhoto() {
            capturedImage.style.display = 'none';
            capturedImage.style.opacity = 0;
            downloadButton.style.display = 'none';
            readButton.style.display = 'none';
            retakeButton.style.display = 'none';
            captureButton.style.display = 'inline-block';
            captureButton.textContent = "Bắt Đầu"; // Reset nhãn nút sau khi chụp lại

            // Stop the video stream if it's active
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            cameraStarted = false; // Reset trạng thái camera

            // Show placeholder image and hide video and overlay
            placeholderImage.style.display = 'block';
            video.style.display = 'none';
            overlay.style.display = 'none';
            predictionResult.innerHTML = "";
            signMeaning.textContent = "";
            signMeaning.style.display = 'none'; // Ẩn signMeaning khi chụp lại
        }

        /**
         * Hàm đọc văn bản bằng giọng nói
         * @param {string} text - Văn bản cần đọc
         */
        function speakText(text) {
            if (!('speechSynthesis' in window)) {
                console.warn('Trình duyệt của bạn không hỗ trợ Speech Synthesis.');
                return;
            }

            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance(text);
            const voices = synth.getVoices();
            const vietnameseVoices = voices.filter(voice => voice.lang.startsWith('vi'));

            if (vietnameseVoices.length > 0) {
                utterThis.voice = vietnameseVoices[0];
            }

            synth.speak(utterThis);
        }

        /**
         * Hàm tải mô hình TensorFlow.js
         */
        async function loadModel() {
            try {
                // Tải mô hình từ GitHub Pages
                model = await tf.loadLayersModel(MODEL_URL + "model.json");
                loadingModel.style.display = 'none';

                // Tải metadata.json để lấy nhãn
                const response = await fetch(MODEL_URL + "metadata.json");
                if (response.ok) {
                    const metadata = await response.json();
                    if (metadata.labels && Array.isArray(metadata.labels)) {
                        labels = metadata.labels;
                        signCount.textContent = labels.length;

                        // Lưu labels vào biến toàn cục để sử dụng sau
                        window.labels = labels;
                    } else {
                        console.warn("metadata.json không chứa trường 'labels' hoặc không phải là một mảng.");
                        // Nếu không có labels trong metadata.json, bạn có thể định nghĩa nhãn trực tiếp ở đây
                        window.labels = ["P.101", "W.208", "W.205", "W.207", "P.103"]; // Thay đổi theo nhu cầu
                        signCount.textContent = window.labels.length;
                    }
                } else {
                    console.warn("Không thể tải metadata.json. Sử dụng nhãn từ mã JavaScript hoặc định nghĩa trong metadata.json.");
                    // Nếu không thể tải metadata.json, định nghĩa nhãn trực tiếp trong mã JavaScript
                    window.labels = ["P.101", "W.208", "W.205", "W.207", "P.103"]; // Thay đổi theo nhu cầu
                    signCount.textContent = window.labels.length;
                }

                // Tải signMeanings.json
                await loadSignMeanings();

                // Tải và xây dựng QA
                await loadQA();
            } catch (err) {
                console.error("Lỗi khi tải mô hình: ", err);
                loadingModel.textContent = "Không thể tải mô hình.";
            }
        }

        /**
         * Hàm thực hiện dự đoán hình ảnh
         */
        async function predictImage(imageSrc) {
            if (!model) {
                predictionResult.textContent = "Mô hình chưa được tải. Vui lòng thử lại sau.";
                loadingPrediction.style.display = 'none';
                return;
            }

            if (Object.keys(signMeanings).length === 0) {
                predictionResult.textContent = "Không có dữ liệu ý nghĩa biển báo. Vui lòng thử lại sau.";
                loadingPrediction.style.display = 'none';
                return;
            }

            try {
                // Tải hình ảnh từ src
                const img = new Image();
                img.src = imageSrc;
                await img.decode();

                // Tạo canvas để chuẩn bị dữ liệu cho mô hình
                const tempCanvas = document.createElement('canvas');
                const context = tempCanvas.getContext('2d');
                tempCanvas.width = 224; // Kích thước chuẩn cho mô hình
                tempCanvas.height = 224;
                context.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);

                // Sử dụng tf.tidy để giải phóng bộ nhớ sau khi thực hiện dự đoán
                tf.tidy(() => {
                    // Chuyển đổi canvas thành tensor
                    const tensor = tf.browser.fromPixels(tempCanvas)
                        .resizeBilinear([224, 224])
                        .toFloat()
                        .div(255.0)
                        .expandDims();

                    // Thực hiện dự đoán
                    const predictions = model.predict(tensor);
                    const data = predictions.dataSync();

                    // Tìm lớp có xác suất cao nhất
                    let maxProb = -1;
                    let maxIndex = -1;
                    for (let i = 0; i < data.length; i++) {
                        if (data[i] > maxProb) {
                            maxProb = data[i];
                            maxIndex = i;
                        }
                    }

                    if (maxIndex !== -1 && window.labels) {
                        const predictedClass = window.labels[maxIndex];
                        predictionResult.innerHTML = `<span style="color: var(--primary-color);">Kết quả: ${predictedClass} (${(maxProb * 100).toFixed(2)}%)</span>`;
                        const signCode = predictedClass.substring(0, 5).toUpperCase();
                        if (signMeanings.hasOwnProperty(signCode)) {
                            const meaningText = `Ý nghĩa: ${signMeanings[signCode]}`;
                            signMeaning.textContent = meaningText;
                            signMeaning.style.display = 'block'; // Hiển thị phần signMeaning
                            readButton.style.display = 'inline-block';
                            quizButton.style.display = 'inline-block';
                        } else {
                            signMeaning.textContent = "Ý nghĩa: Đây là một hình ảnh không phải là hình biển báo giao thông. Bạn hãy nhấn vào nút Chụp lại hoặc nút Tải ảnh lên để kiểm tra. Lưu ý để kết quả nhận diện đúng cần đảm bảo chất lượng ảnh chụp rõ nét, đảm bảo kích thước.";
                            signMeaning.style.display = 'block'; // Hiển thị phần signMeaning
                            readButton.style.display = 'inline-block';
                            quizButton.style.display = 'inline-block';
                        }
                    } else {
                        predictionResult.innerHTML = `<span style="color: var(--error-color);">Không có kết quả nhận diện.</span>`;
                        signMeaning.textContent = "";
                        signMeaning.style.display = 'none'; // Ẩn phần signMeaning
                        readButton.style.display = 'none';
                        quizButton.style.display = 'none';
                    }
                });
            } catch (err) {
                console.error("Lỗi khi nhận diện hình ảnh: ", err);
                predictionResult.innerHTML = `<span style="color: var(--error-color);">Lỗi khi nhận diện hình ảnh.</span>`;
                signMeaning.textContent = "";
                signMeaning.style.display = 'none'; // Ẩn phần signMeaning
                readButton.style.display = 'none';
                quizButton.style.display = 'none';
            } finally {
                loadingPrediction.style.display = 'none';
            }
        }

        /**
         * Event listener cho nút "Đọc"
         */
        readButton.addEventListener('click', () => {
            const text = signMeaning.textContent.replace(/^Ý nghĩa: /, ""); // Loại bỏ tiền tố "Ý nghĩa: " nếu cần
            if (text) {
                speakText(text);
            }
        });

        /**
         * Event listener cho nút làm bài kiểm tra
         */
        quizButton.addEventListener('click', () => {
            window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank');
        });

        /**
         * Cập nhật danh sách giọng nói khi chúng thay đổi
         */
        window.speechSynthesis.onvoiceschanged = function() {
            window.speechSynthesis.getVoices();
        };

        /**
         * Khởi động ứng dụng khi trang được tải
         */
        window.addEventListener('load', async () => {
            await loadModel();
            // Không khởi động camera ngay khi tải trang
            startSloganRotation(); // Khởi động vòng quay khẩu hiệu
        });

        /**
         * Dừng camera khi trang được đóng hoặc tải lại
         */
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // Event listener cho nút "Chụp Ảnh"
        captureButton.addEventListener('click', capturePhoto);

        // Event listener cho nút "Chụp Lại"
        retakeButton.addEventListener('click', retakePhoto);

        // Thêm sự kiện cho nút "Tải Ảnh Xuống"
        downloadButton.addEventListener('click', downloadPhoto);

        // Event listener cho nút "Tải Ảnh Lên"
        uploadButton.addEventListener('click', () => {
            uploadInput.click(); // Trigger click on hidden file input
        });

        // Event listener cho việc chọn file từ file input
        uploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Mở Crop Modal với hình ảnh đã tải lên
                    openCropModal(e.target.result);
                };
                reader.readAsDataURL(file);
            } else {
                alert("Vui lòng chọn một tệp ảnh hợp lệ.");
            }
        });

        /**
         * Xử lý khi người dùng xác nhận cắt ảnh
         */
        confirmCropButton.addEventListener('click', () => {
            if (cropper) {
                const croppedCanvas = cropper.getCroppedCanvas({
                    width: 224,
                    height: 224,
                    imageSmoothingQuality: 'high',
                });
                const croppedImageDataURL = croppedCanvas.toDataURL('image/png');
                capturedImage.src = croppedImageDataURL;
                capturedImage.style.display = 'block';
                capturedImage.style.opacity = 1;
                downloadButton.style.display = 'inline-block';
                retakeButton.style.display = 'inline-block';
                predictionResult.innerHTML = "";
                signMeaning.textContent = "";
                signMeaning.style.display = 'none'; // Ẩn signMeaning khi cắt ảnh
                readButton.style.display = 'none'; // Ẩn nút đọc ban đầu
                quizButton.style.display = 'none'; // Ẩn nút kiểm tra ban đầu

                // Đóng Crop Modal
                closeCropModal();

                // Thực hiện dự đoán với hình ảnh đã cắt
                predictImage(croppedImageDataURL);
            }
        });

        /**
         * Xử lý khi người dùng hủy bỏ cắt ảnh
         */
        cancelCropButton.addEventListener('click', () => {
            closeCropModal();

            // Nếu ảnh được chụp từ camera, hiển thị lại video
            if (cameraStarted) {
                capturedImage.style.display = 'none';
                capturedImage.style.opacity = 0;
                downloadButton.style.display = 'none';
                retakeButton.style.display = 'none';
                readButton.style.display = 'none';
                quizButton.style.display = 'none';
            }
        });

        /**
         * Hàm khởi động khẩu hiệu
         */
        const slogans = [
            "An toàn giao thông - Hạnh phúc cho mọi nhà!",
            "Đi đúng làn đường, an toàn trên mọi nẻo đường!",
            "Đội mũ bảo hiểm - Vẹn tròn tương lai!",
            "Đi bộ trên vỉa hè - An toàn cho bạn và mọi người!",
            "Tuân thủ luật giao thông - Bảo vệ chính mình!",
            "Không phóng nhanh, vượt ẩu - An toàn là trên hết!",
            "Chậm mà chắc - Về nhà an toàn!"
        ];

        let currentSloganIndex = 0;
        const sloganElement = document.getElementById('slogan');
        const sloganSection = document.querySelector('.slogan-section');

        function showSlogan(index) {
            sloganElement.textContent = slogans[index];
            sloganSection.classList.add('active');
            setTimeout(() => {
                sloganSection.classList.remove('active');
            }, 6000); // Hiển thị khẩu hiệu trong 6 giây để tạo khoảng trống cho hiệu ứng mờ dần
        }

        function startSloganRotation() {
            showSlogan(currentSloganIndex);
            currentSloganIndex = (currentSloganIndex + 1) % slogans.length;
            setInterval(() => {
                showSlogan(currentSloganIndex);
                currentSloganIndex = (currentSloganIndex + 1) % slogans.length;
            }, 7000); // Mỗi 7 giây một khẩu hiệu
        }

        /**
         * Event Listener cho Modal Hướng Dẫn
         */
        const instructionButton = document.getElementById('instructionButton');
        const instructionModal = document.getElementById('instructionModal');
        const closeButton = document.querySelector('.close-button');

        // Open the modal
        instructionButton.addEventListener('click', () => {
            instructionModal.style.display = 'block';
            instructionModal.setAttribute('aria-hidden', 'false');
        });

        // Close the modal khi 'x' được nhấn
        closeButton.addEventListener('click', () => {
            instructionModal.style.display = 'none';
            instructionModal.setAttribute('aria-hidden', 'true');
        });

        // Close the modal khi nhấn ngoài nội dung modal
        window.addEventListener('click', (event) => {
            if (event.target == instructionModal) {
                instructionModal.style.display = 'none';
                instructionModal.setAttribute('aria-hidden', 'true');
            }
            if (event.target == cropModal) {
                closeCropModal();
            }
        });
    </script>

</body>
</html>
