<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Nhận Diện Biển Báo Giao Thông</title>
    <!-- Thêm Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables và các kiểu CSS khác giữ nguyên */
        :root {
            --primary-color: #28a745;
            --secondary-color: #007bff;
            --accent-color: #17a2b8;
            --warning-color: #ffc107;
            --purple-color: #6f42c1;
            --dark-color: #333;
            --light-bg: #f0f4f8;
            --white-bg: #fff;
            --text-color: #654321; /* Màu chữ nội dung */
            --error-color: #d9534f;
            --disabled-color: #cccccc;
            --focus-outline: #ffbf47;
            --accordion-bg: #e9ecef;
            --accordion-hover: #dee2e6;
            --accordion-active: #ced4da;
            --qa-question-font: 'Roboto', sans-serif;
            --qa-answer-font: 'Open Sans', sans-serif;
            --question-color: #654321; /* Màu chữ câu hỏi */
            --slogan-font: 'Roboto', sans-serif;
            --slogan-color: #ffffff;
            --slogan-bg-color: var(--footer-bg-color); /* Được thay đổi để giống footer */
            --slogan-padding: 20px;
            --slogan-border-radius: 15px;
            --slogan-font-size: 1.2em; /* Giảm kích thước font */
            --slogan-transition: opacity 1s ease-in-out;
            --footer-bg-color: #007bff; /* Màu nền footer xanh */
            --footer-text-color: #ffffff; /* Màu chữ footer trắng */
            --modal-bg-color: rgba(0, 0, 0, 0.6); /* Nền modal đậm hơn */
            --modal-content-bg: #ffffff; /* Nền nội dung modal trắng */
            --modal-content-border: #28a745; /* Viền nội dung modal màu xanh lá */
            --modal-padding: 30px;
            --modal-border-radius: 10px;
            --modal-title-color: var(--primary-color);
            --modal-text-color: #333;
            --learning-bg-color: #f8f9fa; /* Màu nền cho phần Tìm hiểu */
            --card-bg-color: #ffffff; /* Màu nền cho card */
            --card-border-color: #dee2e6; /* Màu viền cho card */
            --card-hover-bg: #e9ecef; /* Màu nền khi hover card */
            --card-hover-transform: translateY(-5px);
            --card-transition: transform 0.3s ease, background-color 0.3s ease;
            --section-title-bg: #007bff; /* Màu nền cho tiêu đề các phần */
            --section-title-color: #ffffff; /* Đổi từ #654321 thành màu trắng */
            --section-title-padding: 10px 20px;
            --section-title-border-radius: 8px 8px 0 0;
            --fixed-slogan-width: 100%; /* Cố định chiều rộng 100% */
            --fixed-slogan-height: 80px; /* Chiều cao cố định */
        }

        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--qa-question-font); /* Sử dụng Roboto cho toàn bộ trang */
            background-color: var(--light-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 100px 20px 20px 20px; /* Top padding để tránh nội dung bị che khuất bởi khẩu hiệu */
            min-height: 100vh;
        }

        /* Phần Tiêu Đề Các Phần */
        .section-title {
            width: 100%;
            max-width: 800px;
            background-color: var(--section-title-bg);
            color: var(--section-title-color); /* Đã thay đổi thành màu trắng */
            padding: var(--section-title-padding);
            border-radius: var(--section-title-border-radius);
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.1em; /* Giảm kích thước font chữ */
            font-family: var(--qa-question-font);
            font-weight: normal; /* Không in đậm */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Phần 1: Khẩu Hiệu */
        .slogan-section {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--fixed-slogan-width);
            height: var(--fixed-slogan-height);
            background: var(--slogan-bg-color); /* Đã thay đổi để giống footer */
            padding: var(--slogan-padding);
            border-radius: 0; /* Bỏ border-radius khi cố định */
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: width 0.3s ease;
            z-index: 1000;
        }

        #slogan {
            font-family: var(--slogan-font);
            font-size: var(--slogan-font-size);
            color: var(--slogan-color); /* Đã thay đổi để giống footer */
            opacity: 0;
            transition: var(--slogan-transition);
            text-align: center;
            word-wrap: break-word;
            font-weight: normal; /* Không in đậm */
            white-space: nowrap; /* Không tự động co giãn */
            overflow: hidden; /* Ẩn phần tràn */
            text-overflow: ellipsis; /* Thêm dấu chấm lửng nếu văn bản dài */
        }

        .slogan-section.active #slogan {
            opacity: 1;
        }

        /* Phần 2: Nhận Diện Biển Báo Giao Thông */
        .recognition-section {
            width: 100%;
            max-width: 800px;
            background-color: var(--white-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; /* Để overlay hoạt động đúng */
            margin-bottom: 30px;
        }

        .recognition-section h2 {
            /* Đã chuyển từ var(--dark-color) sang var(--section-title-color) để giữ màu trắng */
            color: var(--section-title-color);
            margin-bottom: 20px;
            font-size: 1.1em; /* Giảm kích thước font */
            text-align: center;
            font-family: var(--qa-question-font);
            font-weight: normal; /* Không in đậm */
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 600px;
        }

        /* Placeholder Image Styles */
        #placeholderImage {
            width: 100%;
            max-width: 600px;
            height: auto;
            border: 4px solid var(--primary-color);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            object-fit: cover;
            display: block; /* Show by default */
        }

        /* Video Styles */
        #video, #capturedImage {
            border: 4px solid var(--primary-color);
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            height: auto;
            max-height: 400px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: opacity 0.5s ease, transform 0.3s ease;
            object-fit: cover;
        }

        #video {
            display: none; /* Hide video initially */
        }

        #capturedImage {
            display: none; /* Ẩn ban đầu */
            opacity: 0;
        }

        /* Cải thiện thiết kế Overlay */
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60%; /* Giảm kích thước để tạo không gian xung quanh */
            height: 60%;
            transform: translate(-50%, -50%);
            border: 3px solid rgba(40, 167, 69, 0.8); /* Sử dụng màu sắc trong suốt */
            border-radius: 20px; /* Đường viền tròn hơn để thẩm mỹ */
            box-sizing: border-box;
            pointer-events: none; /* Không chặn các tương tác với video */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* Thêm bóng đổ để nổi bật */
            display: none; /* Hide overlay initially */
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
        }

        button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            flex: 1 1 160px; /* Đảm bảo nút có cùng kích thước */
            max-width: 220px; /* Giới hạn kích thước tối đa */
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: #ffffff; /* Đổi từ #fff sang trắng */
            text-align: center;
            min-height: 44px; /* Đảm bảo touch target đủ lớn */
        }

        /* Các màu sắc cho các nút */
        #instructionButton {
            background-color: var(--accent-color);
        }

        #captureButton {
            background-color: var(--primary-color);
        }

        #uploadButton {
            background-color: var(--secondary-color);
        }

        #downloadButton {
            background-color: var(--secondary-color);
            display: none; /* Ẩn ban đầu */
        }

        #readButton {
            background-color: var(--accent-color);
            display: none; /* Initially hidden */
        }

        #retakeButton {
            background-color: var(--warning-color);
            display: none;
            color: var(--dark-color);
        }

        #quizButton {
            background-color: var(--purple-color);
            display: none; /* Initially hidden */
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.05);
        }

        button:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        button:focus {
            outline: 3px solid var(--focus-outline); /* Màu nổi bật khi focus */
            outline-offset: 2px;
        }

        @media (max-width: 600px) {
            .slogan-section {
                width: 100%; /* Trên thiết bị nhỏ, chiều rộng 100% */
                /* Đặt chiều cao cố định thay vì auto */
                height: var(--fixed-slogan-height);
                padding: 10px;
            }

            body {
                padding: 120px 10px 10px 10px; /* Điều chỉnh padding để phù hợp với thiết bị nhỏ */
            }

            button {
                width: 100%;
                max-width: 220px;
            }

            #slogan {
                font-size: 1em; /* Giảm kích thước font trên thiết bị nhỏ */
                white-space: nowrap; /* Không cho xuống dòng */
                overflow: hidden; /* Ẩn phần tràn */
                text-overflow: ellipsis; /* Thêm dấu chấm lửng nếu văn bản dài */
            }

            .section-title {
                font-size: 1.1em; /* Giảm kích thước font chữ cho tiêu đề */
            }

            .recognition-section h2 {
                font-size: 1.1em; /* Giảm kích thước font chữ cho tiêu đề */
            }

            /* Optional: Adjust slogan font size further if needed */
            /* #slogan {
                font-size: 0.9em;
            } */
        }

        #predictionResult {
            margin-top: 20px;
            font-size: 16px; /* Giảm kích thước font chữ */
            font-weight: bold;
            color: var(--dark-color);
            min-height: 50px;
            text-align: center;
            width: 100%;
        }

        /* Định dạng hướng dẫn sử dụng */
        #predictionResult h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--primary-color);
            text-align: center;
        }

        #predictionResult ol {
            text-align: left;
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            padding-left: 20px;
            font-size: 0.9em; /* Giảm kích thước font chữ */
            color: var(--text-color);
            list-style-position: inside; /* Căn đều các dấu đầu dòng */
            font-family: var(--qa-answer-font); /* Sử dụng Open Sans cho danh sách */
        }

        #predictionResult li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        /* Định dạng số lượng biển báo */
        #signCount {
            margin-top: 10px;
            font-size: 16px;
            color: var(--error-color); /* Màu đỏ để làm nổi bật */
            text-align: center;
            font-weight: bold;
        }

        #signMeaning {
            display: none; /* Ẩn phần này ban đầu */
            margin-top: 10px;
            font-size: 16px;
            color: var(--text-color);
            text-align: left; /* Đổi từ center sang left */
            max-width: 600px;
            width: 100%;
            padding: 15px;
            background-color: #f8f9fa; /* Thêm nền màu nhẹ */
            border: 1px solid var(--primary-color); /* Thêm viền màu xanh lá */
            border-radius: 8px; /* Bo tròn các góc */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Thêm bóng đổ nhẹ */
            line-height: 1.6; /* Tăng khoảng cách giữa các dòng */
            font-family: var(--qa-answer-font); /* Sử dụng Open Sans cho nội dung */
        }

        /* Loading Spinner Styles */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingModel, #loadingPrediction {
            margin-top: 20px;
            font-size: 18px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Phần 4: Hỏi Đáp (QA) */
        .qa-section {
            width: 100%;
            max-width: 800px;
            background-color: var(--white-bg); /* Nền trắng */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
        }

        .qa-section h2 {
            color: var(--section-title-color); /* Đã thay đổi thành màu trắng */
            margin-bottom: 20px;
            font-size: 1.1em; /* Giảm kích thước font chữ */
            text-align: center;
            font-family: var(--qa-question-font);
            font-weight: normal; /* Không in đậm */
        }

        .accordion {
            background-color: var(--white-bg);
            color: var(--question-color); /* Đổi màu sắc của câu hỏi */
            cursor: pointer;
            padding: 20px; /* Tăng padding để làm rộng chiều dài */
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.1em; /* Tăng kích thước font chữ */
            font-weight: 700; /* Tăng độ đậm của font chữ */
            transition: background-color 0.3s ease;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: var(--qa-question-font);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .accordion:hover {
            background-color: var(--accordion-hover);
        }

        .accordion.active {
            background-color: var(--accordion-active);
        }

        /* Biểu tượng mũi tên cho accordion */
        .accordion::after {
            content: '\002B'; /* Plus sign */
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .accordion.active::after {
            content: '\2212'; /* Minus sign */
        }

        /* Panel styles with smooth transition */
        .panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background-color: var(--white-bg);
            border-left: 3px solid var(--primary-color);
            border-right: 3px solid var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            border-radius: 0 0 5px 5px;
            margin-bottom: 15px;
        }

        .panel.show {
            max-height: 500px; /* Adjust as needed */
        }

        .panel p {
            padding: 10px 15px;
            color: var(--text-color);
            font-family: var(--qa-answer-font);
            line-height: 1.6;
        }

        .panel ul {
            list-style-type: disc;
            padding-left: 30px;
            font-family: var(--qa-answer-font);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: var(--modal-bg-color); /* Nền modal đậm hơn */
        }

        .modal-content {
            background-color: var(--modal-content-bg);
            margin: 5% auto; /* 5% từ trên và giữa */
            padding: var(--modal-padding);
            border: 2px solid var(--modal-content-border);
            width: 80%; /* Có thể điều chỉnh tùy theo kích thước màn hình */
            border-radius: var(--modal-border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            color: var(--modal-title-color);
            margin-bottom: 15px;
            font-size: 1.8em;
            text-align: center;
        }

        .modal-content ol {
            text-align: left;
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            padding-left: 20px;
            font-size: 1em; /* Tăng kích thước font chữ */
            color: var(--modal-text-color);
            list-style-position: inside; /* Căn đều các dấu đầu dòng */
            font-family: var(--qa-answer-font); /* Sử dụng Open Sans cho danh sách */
        }

        .modal-content li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .modal-content p {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            color: var(--error-color);
        }

        /* Phần 6: Footer */
        .footer {
            width: 100%;
            text-align: center;
            padding: 20px;
            font-size: 14px;
            color: var(--footer-text-color);
            background-color: var(--footer-bg-color); /* Nền xanh */
            border-radius: 10px;
            position: relative; /* Để không bị che khuất bởi khẩu hiệu cố định */
            margin-top: 30px;
        }

        /* Nút "Làm Bài Kiểm Tra" */
        #quizButton-container {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

    </style>
</head>
<body>

    <!-- Phần 1: Khẩu Hiệu Tham Gia Giao Thông -->
    <div class="slogan-section active">
        <p id="slogan">Đi bộ trên vỉa hè - An toàn cho bạn và mọi người!</p>
    </div>

    <!-- Phần 2: Nhận Diện Biển Báo Giao Thông -->
    <div class="recognition-section">
        <h2 class="section-title">Nhận Diện Biển Báo Giao Thông</h2>
        <div class="video-container">
            <!-- Placeholder Image -->
            <img id="placeholderImage" src="https://duan-khkt2024.github.io/bienbaogiaothong/model/h1.jpg" alt="Ứng dụng Nhận Diện Biển Báo Giao Thông">
            <!-- Video Element -->
            <video id="video" autoplay playsinline aria-label="Video từ camera"></video>
            <div class="overlay"></div>
        </div>
        <img id="capturedImage" alt="Ảnh đã chụp">
        <canvas id="canvas" style="display: none;"></canvas>

        <div class="button-container">
            <button id="instructionButton" aria-label="Hướng Dẫn">Hướng Dẫn</button>
            <button id="captureButton" aria-label="Chụp ảnh">Bắt Đầu</button>
            <button id="uploadButton" aria-label="Tải ảnh lên">Tải Ảnh Lên</button>
            <button id="downloadButton" aria-label="Tải ảnh xuống">Tải Ảnh Xuống</button>
            <button id="readButton" aria-label="Đọc ý nghĩa biển báo">Đọc</button>
            <button id="retakeButton" aria-label="Chụp lại">Chụp Lại</button>
        </div>

        <!-- Hidden file input for uploading images -->
        <input type="file" id="uploadInput" accept="image/*" style="display: none;" />

        <div id="loadingModel">
            Đang tải mô hình...
            <div class="spinner"></div>
        </div>
        <div id="loadingPrediction" style="display: none;">
            Đang nhận diện...
            <div class="spinner"></div>
        </div>
        <div id="predictionResult" aria-live="polite"></div>
        <div id="signMeaning" aria-live="polite"></div>

        <!-- Nút "Làm Bài Kiểm Tra" -->
        <div id="quizButton-container">
            <button id="quizButton" aria-label="Làm bài kiểm tra" title="Làm bài kiểm tra giao thông">Làm Bài Kiểm Tra</button>
        </div>
    </div>

    <!-- Phần 4: Hỏi Đáp (QA) -->
    <div class="qa-section">
        <h2 class="section-title">Hỏi Đáp</h2>
        <div id="qa-container">
            <!-- Nội dung Hỏi Đáp sẽ được thêm vào đây bằng JavaScript -->
        </div>
    </div>

    <!-- Footer với nền xanh và chữ trắng -->
    <div class="footer">
        &copy; 2024 Ứng dụng AI nhận diện biển báo và tìm hiểu Luật giao thông đường bộ cho Học Sinh THCS
    </div>

    <!-- Modal Hướng Dẫn -->
    <div id="instructionModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="instructionModalTitle" aria-describedby="instructionModalDescription">
        <div class="modal-content">
            <span class="close-button" aria-label="Đóng">&times;</span>
            <h2 id="instructionModalTitle">Hướng Dẫn Sử Dụng</h2>
            <div id="instructionModalDescription">
                <ol>
                    <li>Nhấn nút <strong>"Bắt Đầu"</strong> để khởi động camera.</li>
                    <li>Khi camera đã khởi động, nhấn nút <strong>"Chụp Ảnh"</strong> để bắt đầu quá trình chụp hình biển báo giao thông.</li>
                    <li>Đảm bảo camera của bạn được đặt sao cho biển báo rõ ràng và trung tâm trong khung hình.</li>
                    <li>Sau khi chụp, hệ thống sẽ tự động nhận diện biển báo và hiển thị kết quả.</li>
                    <li>Nhấn nút <strong>"Đọc"</strong> để nghe lại ý nghĩa của biển báo đã nhận diện.</li>
                    <li>Chọn nút <strong>"Làm Bài Kiểm Tra"</strong> để thực hiện bài kiểm tra giao thông.</li>
                </ol>
                <p>Số lượng biển báo có thể nhận diện: <strong id="totalSigns">0</strong></p>
            </div>
        </div>
    </div>

    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>

    <script>
        // Các phần tử DOM
        const video = document.getElementById('video');
        const placeholderImage = document.getElementById('placeholderImage');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const uploadButton = document.getElementById('uploadButton');
        const uploadInput = document.getElementById('uploadInput'); // Hidden file input
        const downloadButton = document.getElementById('downloadButton');
        const readButton = document.getElementById('readButton');
        const retakeButton = document.getElementById('retakeButton');
        const capturedImage = document.getElementById('capturedImage');
        const predictionResult = document.getElementById('predictionResult');
        const signMeaning = document.getElementById('signMeaning');
        const loadingModel = document.getElementById('loadingModel');
        const loadingPrediction = document.getElementById('loadingPrediction');
        const signCount = document.getElementById('totalSigns');
        const quizButton = document.getElementById('quizButton');
        const overlay = document.querySelector('.overlay');
        let stream = null;
        let isProcessing = false;
        let cameraStarted = false; // Biến trạng thái camera
        const MODEL_URL = "https://duan-khkt2024.github.io/bienbaogiaothong/model/";
        let model;
        let labels = []; // Danh sách nhãn sẽ được tải từ metadata.json

        let signMeanings = {};
        let qaData = [];

        /**
         * Hàm tải signMeanings.json
         */
        async function loadSignMeanings() {
            try {
                const response = await fetch(MODEL_URL + "signMeanings.json");
                if (response.ok) {
                    signMeanings = await response.json();
                    console.log("Đã tải thành công signMeanings.json");
                } else {
                    console.warn("Không thể tải signMeanings.json. Đang sử dụng signMeanings mặc định.");
                    // Bạn có thể định nghĩa signMeanings mặc định ở đây nếu cần
                }
            } catch (error) {
                console.error("Lỗi khi tải signMeanings.json:", error);
                // Xử lý lỗi nếu cần
            }
        }

        /**
         * Hàm tải qa.json
         */
        async function loadQA() {
            try {
                const response = await fetch(MODEL_URL + "qa.json");
                if (response.ok) {
                    const data = await response.json();
                    qaData = data.questions;
                    console.log("Đã tải thành công qa.json");
                    buildQA();
                } else {
                    console.warn("Không thể tải qa.json.");
                    // Bạn có thể định nghĩa dữ liệu QA mặc định ở đây nếu cần
                }
            } catch (error) {
                console.error("Lỗi khi tải qa.json:", error);
                // Xử lý lỗi nếu cần
            }
        }

        /**
         * Hàm xây dựng phần Hỏi Đáp
         */
        function buildQA() {
            const qaContainer = document.getElementById('qa-container');
            qaContainer.innerHTML = ''; // Xóa nội dung cũ nếu có

            qaData.forEach((item, index) => {
                // Tạo nút accordion
                const accordionButton = document.createElement('button');
                accordionButton.classList.add('accordion');
                accordionButton.setAttribute('aria-expanded', 'false');
                accordionButton.setAttribute('aria-controls', `qa-panel-${index}`);
                accordionButton.textContent = item.question;

                // Tạo panel
                const panelDiv = document.createElement('div');
                panelDiv.classList.add('panel');
                panelDiv.id = `qa-panel-${index}`;

                // Tạo phần nội dung câu trả lời
                const answerPara = document.createElement('p');
                answerPara.textContent = item.answer;

                // Tạo danh sách các điểm
                const pointsList = document.createElement('ul');
                item.points.forEach(point => {
                    const listItem = document.createElement('li');
                    listItem.textContent = point;
                    pointsList.appendChild(listItem);
                });

                panelDiv.appendChild(answerPara);
                panelDiv.appendChild(pointsList);

                // Thêm vào container
                qaContainer.appendChild(accordionButton);
                qaContainer.appendChild(panelDiv);
            });

            // Thêm event listeners cho các nút accordion vừa tạo
            document.querySelectorAll('.accordion').forEach(button => {
                button.addEventListener('click', function() {
                    const isActive = this.classList.contains('active');
                    this.setAttribute('aria-expanded', !isActive);
                    this.classList.toggle('active');
                    const panel = this.nextElementSibling;
                    if (panel.classList.contains('show')) {
                        panel.classList.remove('show');
                        panel.style.maxHeight = null;
                    } else {
                        panel.classList.add('show');
                        panel.style.maxHeight = panel.scrollHeight + "px";
                    }
                });
            });
        }

        /**
         * Hàm khởi động camera
         */
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        // Optional: thêm các constraints khác nếu cần
                    },
                    audio: false
                });
                video.srcObject = stream;
                return new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                    video.onerror = (err) => {
                        reject(err);
                    };
                });
            } catch (err) {
                console.error("Không thể truy cập camera: ", err);
                alert("Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc thiết bị của bạn.");
            }
        }

        /**
         * Hàm chụp ảnh từ video
         */
        async function capturePhoto() {
            if (isProcessing) return;
            isProcessing = true;
            captureButton.disabled = true;

            if (!cameraStarted) {
                // Nếu camera chưa được khởi động, bắt đầu camera
                try {
                    // Hide placeholder image and show video
                    placeholderImage.style.display = 'none';
                    video.style.display = 'block';
                    overlay.style.display = 'block'; // Show overlay when video is active

                    await startCamera();
                    cameraStarted = true;
                    captureButton.textContent = "Chụp Ảnh"; // Thay đổi nhãn nút sau khi camera đã khởi động
                } catch (err) {
                    console.error("Lỗi khi khởi động camera: ", err);
                    alert("Không thể khởi động camera.");
                } finally {
                    isProcessing = false;
                    captureButton.disabled = false;
                }
            } else {
                // Nếu camera đã được khởi động, tiến hành chụp ảnh
                loadingPrediction.style.display = 'flex';

                try {
                    // Kiểm tra xem video đã sẵn sàng chưa
                    if (video.readyState < 3) { // HAVE_CURRENT_DATA = 2, HAVE_FUTURE_DATA = 3
                        await new Promise((resolve) => {
                            video.oncanplay = () => {
                                resolve();
                            };
                        });
                    }

                    const context = canvas.getContext('2d');
                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;

                    if (videoWidth === 0 || videoHeight === 0) {
                        throw new Error("Video chưa sẵn sàng.");
                    }

                    // Kích thước và vị trí của overlay (60% chiều rộng và chiều cao)
                    const overlayWidth = videoWidth * 0.6;
                    const overlayHeight = videoHeight * 0.6;
                    const sx = (videoWidth - overlayWidth) / 2;
                    const sy = (videoHeight - overlayHeight) / 2;

                    // Cài đặt kích thước canvas theo kích thước overlay
                    canvas.width = overlayWidth;
                    canvas.height = overlayHeight;

                    // Vẽ phần ảnh trong khu vực overlay vào canvas
                    context.drawImage(video, sx, sy, overlayWidth, overlayHeight, 0, 0, overlayWidth, overlayHeight);

                    const imageDataURL = canvas.toDataURL('image/png');
                    capturedImage.src = imageDataURL;
                    capturedImage.style.display = 'block';
                    capturedImage.style.opacity = 1;
                    video.style.display = 'none';
                    overlay.style.display = 'none';
                    downloadButton.style.display = 'inline-block';
                    retakeButton.style.display = 'inline-block';
                    predictionResult.innerHTML = "";
                    signMeaning.textContent = "";
                    signMeaning.style.display = 'none'; // Ẩn signMeaning khi chụp lại
                    readButton.style.display = 'none'; // Ẩn nút đọc ban đầu
                    quizButton.style.display = 'none'; // Ẩn nút kiểm tra ban đầu

                    await predictImage();
                } catch (error) {
                    console.error("Lỗi khi chụp ảnh: ", error);
                    alert("Đã xảy ra lỗi khi chụp ảnh. Vui lòng thử lại.");
                } finally {
                    isProcessing = false;
                    captureButton.disabled = false;
                }
            }
        }

        /**
         * Hàm tải ảnh xuống
         */
        function downloadPhoto() {
            if (!capturedImage.src) {
                alert("Không có ảnh nào để tải xuống.");
                return;
            }
            const link = document.createElement('a');
            link.href = capturedImage.src;
            link.download = 'anh-chup.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Hàm chụp lại ảnh
         */
        function retakePhoto() {
            capturedImage.style.display = 'none';
            capturedImage.style.opacity = 0;
            downloadButton.style.display = 'none';
            readButton.style.display = 'none';
            retakeButton.style.display = 'none';
            captureButton.style.display = 'inline-block';
            captureButton.textContent = "Bắt Đầu"; // Reset nhãn nút sau khi chụp lại

            // Stop the video stream if it's active
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            cameraStarted = false; // Reset trạng thái camera

            // Show placeholder image and hide video and overlay
            placeholderImage.style.display = 'block';
            video.style.display = 'none';
            overlay.style.display = 'none';
            predictionResult.innerHTML = "";
            signMeaning.textContent = "";
            signMeaning.style.display = 'none'; // Ẩn signMeaning khi chụp lại
        }

        /**
         * Hàm đọc văn bản bằng giọng nói
         * @param {string} text - Văn bản cần đọc
         */
        function speakText(text) {
            if (!('speechSynthesis' in window)) {
                console.warn('Trình duyệt của bạn không hỗ trợ Speech Synthesis.');
                return;
            }

            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance(text);
            const voices = synth.getVoices();
            const vietnameseVoices = voices.filter(voice => voice.lang.startsWith('vi'));

            if (vietnameseVoices.length > 0) {
                utterThis.voice = vietnameseVoices[0];
            }

            synth.speak(utterThis);
        }

        /**
         * Hàm tải mô hình TensorFlow.js
         */
        async function loadModel() {
            try {
                // Tải mô hình từ GitHub Pages
                model = await tf.loadLayersModel(MODEL_URL + "model.json");
                loadingModel.style.display = 'none';

                // Tải metadata.json để lấy nhãn
                const response = await fetch(MODEL_URL + "metadata.json");
                if (response.ok) {
                    const metadata = await response.json();
                    if (metadata.labels && Array.isArray(metadata.labels)) {
                        labels = metadata.labels;
                        signCount.textContent = labels.length;

                        // Lưu labels vào biến toàn cục để sử dụng sau
                        window.labels = labels;
                    } else {
                        console.warn("metadata.json không chứa trường 'labels' hoặc không phải là một mảng.");
                        // Nếu không có labels trong metadata.json, bạn có thể định nghĩa nhãn trực tiếp ở đây
                        window.labels = ["P.101", "W.208", "W.205", "W.207", "P.103"]; // Thay đổi theo nhu cầu
                        signCount.textContent = window.labels.length;
                    }
                } else {
                    console.warn("Không thể tải metadata.json. Sử dụng nhãn từ mã JavaScript hoặc định nghĩa trong metadata.json.");
                    // Nếu không thể tải metadata.json, định nghĩa nhãn trực tiếp trong mã JavaScript
                    window.labels = ["P.101", "W.208", "W.205", "W.207", "P.103"]; // Thay đổi theo nhu cầu
                    signCount.textContent = window.labels.length;
                }

                // Tải signMeanings.json
                await loadSignMeanings();

                // Tải và xây dựng QA
                await loadQA();
            } catch (err) {
                console.error("Lỗi khi tải mô hình: ", err);
                loadingModel.textContent = "Không thể tải mô hình.";
            }
        }

        /**
         * Hàm thực hiện dự đoán hình ảnh
         */
        async function predictImage() {
            if (!model) {
                predictionResult.textContent = "Mô hình chưa được tải. Vui lòng thử lại sau.";
                loadingPrediction.style.display = 'none';
                return;
            }

            if (Object.keys(signMeanings).length === 0) {
                predictionResult.textContent = "Không có dữ liệu ý nghĩa biển báo. Vui lòng thử lại sau.";
                loadingPrediction.style.display = 'none';
                return;
            }

            try {
                // Sử dụng tf.tidy để giải phóng bộ nhớ sau khi thực hiện dự đoán
                tf.tidy(() => {
                    // Chuyển đổi canvas thành tensor
                    const img = tf.browser.fromPixels(canvas);
                    const resized = tf.image.resizeBilinear(img, [224, 224]); // Thay đổi kích thước theo mô hình của bạn
                    const normalized = resized.div(255.0).expandDims();

                    // Thực hiện dự đoán
                    const predictions = model.predict(normalized);
                    const data = predictions.dataSync();

                    // Tìm lớp có xác suất cao nhất
                    let maxProb = -1;
                    let maxIndex = -1;
                    for (let i = 0; i < data.length; i++) {
                        if (data[i] > maxProb) {
                            maxProb = data[i];
                            maxIndex = i;
                        }
                    }

                    if (maxIndex !== -1 && window.labels) {
                        const predictedClass = window.labels[maxIndex];
                        predictionResult.innerHTML = `<span style="color: var(--primary-color);">Kết quả: ${predictedClass} (${(maxProb * 100).toFixed(2)}%)</span>`;
                        const signCode = predictedClass.substring(0, 5).toUpperCase();
                        if (signMeanings.hasOwnProperty(signCode)) {
                            const meaningText = `Ý nghĩa: ${signMeanings[signCode]}`;
                            signMeaning.textContent = meaningText;
                            signMeaning.style.display = 'block'; // Hiển thị phần signMeaning
                            readButton.style.display = 'inline-block';
                            quizButton.style.display = 'inline-block';
                        } else {
                            signMeaning.textContent = "Ý nghĩa: Đây là một hình ảnh không phải là hình biển báo giao thông. Bạn hãy nhấn vào nút Chụp lại hoặc nút Tải ảnh lên để kiểm tra. Lưu ý để kết quả nhận diện đúng cần đảm bảo chất lượng ảnh chụp rõ nét, đảm bảo kích thước.";
                            signMeaning.style.display = 'block'; // Hiển thị phần signMeaning
                            readButton.style.display = 'inline-block';
                            quizButton.style.display = 'inline-block';
                        }
                    } else {
                        predictionResult.innerHTML = `<span style="color: var(--error-color);">Không có kết quả nhận diện.</span>`;
                        signMeaning.textContent = "";
                        signMeaning.style.display = 'none'; // Ẩn phần signMeaning
                        readButton.style.display = 'none';
                        quizButton.style.display = 'none';
                    }
                });
            } catch (err) {
                console.error("Lỗi khi nhận diện hình ảnh: ", err);
                predictionResult.innerHTML = `<span style="color: var(--error-color);">Lỗi khi nhận diện hình ảnh.</span>`;
                signMeaning.textContent = "";
                signMeaning.style.display = 'none'; // Ẩn phần signMeaning
                readButton.style.display = 'none';
                quizButton.style.display = 'none';
            } finally {
                loadingPrediction.style.display = 'none';
            }
        }

        /**
         * Event listener cho nút "Đọc"
         */
        readButton.addEventListener('click', () => {
            const text = signMeaning.textContent.replace(/^Ý nghĩa: /, ""); // Loại bỏ tiền tố "Ý nghĩa: " nếu cần
            if (text) {
                speakText(text);
            }
        });

        /**
         * Event listener cho nút làm bài kiểm tra
         */
        quizButton.addEventListener('click', () => {
            window.open('https://sites.google.com/view/tracnghiemgiaothong', '_blank');
        });

        /**
         * Cập nhật danh sách giọng nói khi chúng thay đổi
         */
        window.speechSynthesis.onvoiceschanged = function() {
            window.speechSynthesis.getVoices();
        };

        /**
         * Khởi động ứng dụng khi trang được tải
         */
        window.addEventListener('load', async () => {
            await loadModel();
            // Không khởi động camera ngay khi tải trang
            startSloganRotation(); // Khởi động vòng quay khẩu hiệu
        });

        /**
         * Dừng camera khi trang được đóng hoặc tải lại
         */
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // Event listener cho nút "Chụp Ảnh"
        captureButton.addEventListener('click', capturePhoto);

        // Event listener cho nút "Chụp Lại"
        retakeButton.addEventListener('click', retakePhoto);

        // Thêm sự kiện cho nút "Tải Ảnh Xuống"
        downloadButton.addEventListener('click', downloadPhoto);

        // Event listener cho nút "Tải Ảnh Lên"
        uploadButton.addEventListener('click', () => {
            uploadInput.click(); // Trigger click on hidden file input
        });

        // Event listener cho việc chọn file từ file input
        uploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    capturedImage.src = e.target.result;
                    capturedImage.style.display = 'block';
                    capturedImage.style.opacity = 1;
                    // Hide video and placeholder image
                    video.style.display = 'none';
                    placeholderImage.style.display = 'none';
                    overlay.style.display = 'none';
                    downloadButton.style.display = 'inline-block';
                    retakeButton.style.display = 'inline-block';
                    predictionResult.innerHTML = "";
                    signMeaning.textContent = "";
                    signMeaning.style.display = 'none'; // Ẩn signMeaning khi tải ảnh lên
                    readButton.style.display = 'none'; // Ẩn nút đọc ban đầu
                    quizButton.style.display = 'none'; // Ẩn nút kiểm tra ban đầu

                    // Vẽ ảnh lên canvas để dự đoán
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const context = canvas.getContext('2d');
                        // Tính toán tỷ lệ để giữ nguyên tỉ lệ ảnh khi vẽ vào canvas
                        const aspectRatio = img.width / img.height;
                        let canvasWidth = 224; // Kích thước chuẩn cho mô hình
                        let canvasHeight = 224;
                        if (aspectRatio > 1) {
                            canvasHeight = canvasWidth / aspectRatio;
                        } else {
                            canvasWidth = canvasHeight * aspectRatio;
                        }
                        canvas.width = canvasWidth;
                        canvas.height = canvasHeight;
                        context.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                        predictImage();
                    };
                };
                reader.readAsDataURL(file);
            } else {
                alert("Vui lòng chọn một tệp ảnh hợp lệ.");
            }
        });

        /**
         * Hàm khởi động khẩu hiệu
         */
        const slogans = [
            "An toàn giao thông - Hạnh phúc cho mọi nhà!",
            "Đi đúng làn đường, an toàn trên mọi nẻo đường!",
            "Đội mũ bảo hiểm - Vẹn tròn tương lai!",
            "Đi bộ trên vỉa hè - An toàn cho bạn và mọi người!",
            "Tuân thủ luật giao thông - Bảo vệ chính mình!",
            "Không phóng nhanh, vượt ẩu - An toàn là trên hết!",
            "Chậm mà chắc - Về nhà an toàn!"
        ];

        let currentSloganIndex = 0;
        const sloganElement = document.getElementById('slogan');
        const sloganSection = document.querySelector('.slogan-section');

        function showSlogan(index) {
            sloganElement.textContent = slogans[index];
            sloganSection.classList.add('active');
            setTimeout(() => {
                sloganSection.classList.remove('active');
            }, 6000); // Hiển thị khẩu hiệu trong 6 giây để tạo khoảng trống cho hiệu ứng mờ dần
        }

        function startSloganRotation() {
            showSlogan(currentSloganIndex);
            currentSloganIndex = (currentSloganIndex + 1) % slogans.length;
            setInterval(() => {
                showSlogan(currentSloganIndex);
                currentSloganIndex = (currentSloganIndex + 1) % slogans.length;
            }, 7000); // Mỗi 7 giây một khẩu hiệu
        }

        /**
         * Event Listener cho Modal Hướng Dẫn
         */
        const instructionButton = document.getElementById('instructionButton');
        const instructionModal = document.getElementById('instructionModal');
        const closeButton = document.querySelector('.close-button');

        // Open the modal
        instructionButton.addEventListener('click', () => {
            instructionModal.style.display = 'block';
            instructionModal.setAttribute('aria-hidden', 'false');
        });

        // Close the modal khi 'x' được nhấn
        closeButton.addEventListener('click', () => {
            instructionModal.style.display = 'none';
            instructionModal.setAttribute('aria-hidden', 'true');
        });

        // Close the modal khi nhấn ngoài nội dung modal
        window.addEventListener('click', (event) => {
            if (event.target == instructionModal) {
                instructionModal.style.display = 'none';
                instructionModal.setAttribute('aria-hidden', 'true');
            }
        });
    </script>

</body>
</html>
