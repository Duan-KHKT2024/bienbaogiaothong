<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Nhận Diện Biển Báo Giao Thông</title>
    <style>
        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #video, #capturedImage {
            border: 4px solid #4CAF50;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            height: auto;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: opacity 0.5s ease, transform 0.3s ease;
            object-fit: cover;
        }

        #capturedImage {
            display: none;
            opacity: 0;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
        }

        button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            min-width: 160px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: #fff;
        }

        #captureButton {
            background-color: #28a745;
        }

        #downloadButton {
            background-color: #007bff;
            display: none;
        }

        #retakeButton {
            background-color: #ffc107;
            display: none;
            color: #333;
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.05);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        @media (max-width: 600px) {
            .zoom-container {
                flex-direction: column;
                align-items: stretch;
            }

            .zoom-container label,
            .zoom-container span {
                text-align: left;
                width: auto;
            }

            .zoom-container input[type="range"] {
                width: 100%;
            }

            button {
                width: 100%;
                max-width: 220px;
            }
        }

        #predictionResult {
            margin-top: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            min-height: 50px;
            text-align: center;
        }

        #signMeaning {
            margin-top: 10px;
            font-size: 16px;
            color: #555;
            text-align: center;
            max-width: 600px;
        }

        /* Loading Spinner Styles */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingModel, #loadingPrediction {
            margin-top: 20px;
            font-size: 18px;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer {
            width: 100%;
            text-align: center;
            padding-top: 20px;
            font-size: 14px;
            color: #888;
        }

        /* Zoom Control Styling */
        .zoom-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }

        .zoom-container label {
            font-size: 16px;
            color: #333;
            flex: 0 0 auto;
        }

        .zoom-container input[type="range"] {
            flex: 1 1 auto;
        }

        .zoom-container span {
            font-size: 16px;
            color: #333;
            flex: 0 0 auto;
            width: 40px;
            text-align: right;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Nhận Diện Biển Báo Giao Thông</h1>
        <video id="video" autoplay playsinline aria-label="Video từ camera"></video>
        <img id="capturedImage" alt="Ảnh đã chụp">
        <canvas id="canvas" style="display: none;"></canvas>

        <div class="zoom-container">
            <label for="zoomSlider">Zoom:</label>
            <input type="range" id="zoomSlider" min="1" max="3" step="0.1" value="1">
            <span id="zoomValue">1x</span>
        </div>

        <div class="button-container">
            <button id="captureButton" aria-label="Chụp ảnh" disabled>Chụp Ảnh</button>
            <button id="downloadButton" aria-label="Tải ảnh xuống">Tải Ảnh Xuống</button>
            <button id="retakeButton" aria-label="Chụp lại">Chụp Lại</button>
        </div>

        <div id="loadingModel">
            Đang tải mô hình...
            <div class="spinner"></div>
        </div>
        <div id="loadingPrediction" style="display: none;">
            Đang nhận diện...
            <div class="spinner"></div>
        </div>
        <div id="predictionResult" aria-live="polite">Kết quả nhận diện sẽ hiển thị ở đây.</div>
        <div id="signMeaning" aria-live="polite"></div>
    </div>

    <div class="footer">
        &copy; 2024 Ứng dụng Nhận Diện Biển Báo Giao Thông
    </div>

    <!-- TensorFlow.js và Teachable Machine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script>
        // Lấy các phần tử từ DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const downloadButton = document.getElementById('downloadButton');
        const retakeButton = document.getElementById('retakeButton');
        const capturedImage = document.getElementById('capturedImage');
        const predictionResult = document.getElementById('predictionResult');
        const signMeaning = document.getElementById('signMeaning');
        const loadingModel = document.getElementById('loadingModel');
        const loadingPrediction = document.getElementById('loadingPrediction');
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        let stream = null;
        let isProcessing = false; // Flag to prevent multiple processing

        // Thông tin mô hình Teachable Machine
        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/7y8Dc7os8/";

        let model, maxPredictions;

        // Bản đồ mã biển báo và ý nghĩa tương ứng
        const signMeanings = {
            "P.101": "Để báo trước nơi giao nhau có điều khiển giao thông bằng tín hiệu đèn trong trường hợp người tham gia giao thông khó quan sát thấy đèn để kịp thời xử lý.",
            "W.208": "Các xe đi trên đường có đặt biển số W.208 phải nhường đường cho xe đi trên đường ưu tiên khi qua nơi giao nhau (trừ các loại xe được quyền ưu tiên theo quy định).",
            // Thêm các mã biển báo khác ở đây
            // "Code": "Ý nghĩa..."
        };

        /**
         * Hàm khởi chạy camera
         */
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                };
                video.style.opacity = 1;
            } catch (err) {
                console.error("Không thể truy cập camera: ", err);
                alert("Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc thiết bị của bạn.");
            }
        }

        /**
         * Hàm dừng camera
         */
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }

        /**
         * Hàm chụp ảnh với zoom
         */
        async function capturePhoto() {
            if (isProcessing) return; // Prevent multiple clicks
            isProcessing = true;
            captureButton.disabled = true;

            try {
                const context = canvas.getContext('2d');
                const zoom = parseFloat(zoomSlider.value);
                const videoWidth = video.videoWidth;
                const videoHeight = video.videoHeight;

                if (videoWidth === 0 || videoHeight === 0) {
                    throw new Error("Video chưa sẵn sàng.");
                }

                // Tính toán kích thước và vị trí cắt dựa trên zoom
                const scaledWidth = videoWidth / zoom;
                const scaledHeight = videoHeight / zoom;
                const sx = (videoWidth - scaledWidth) / 2;
                const sy = (videoHeight - scaledHeight) / 2;

                canvas.width = videoWidth;
                canvas.height = videoHeight;
                context.drawImage(video, sx, sy, scaledWidth, scaledHeight, 0, 0, videoWidth, videoHeight);

                const imageDataURL = canvas.toDataURL('image/png');
                capturedImage.src = imageDataURL;
                capturedImage.style.display = 'block';
                capturedImage.style.opacity = 1;
                video.style.opacity = 0;
                video.style.display = 'none';
                downloadButton.style.display = 'inline-block';
                retakeButton.style.display = 'inline-block';
                captureButton.style.display = 'none';
                predictionResult.textContent = "";
                signMeaning.textContent = "";
                loadingPrediction.style.display = 'flex';
                await predictImage();
            } catch (error) {
                console.error("Lỗi khi chụp ảnh: ", error);
                alert("Đã xảy ra lỗi khi chụp ảnh. Vui lòng thử lại.");
            } finally {
                isProcessing = false;
                if (model) {
                    captureButton.disabled = false;
                }
            }
        }

        /**
         * Hàm tải ảnh xuống
         */
        function downloadPhoto() {
            if (!capturedImage.src) return; // Prevent download if no image
            const link = document.createElement('a');
            link.href = capturedImage.src;
            link.download = 'anh-chup.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Hàm chụp lại
         */
        function retakePhoto() {
            capturedImage.style.display = 'none';
            capturedImage.style.opacity = 0;
            video.style.display = 'block';
            video.style.opacity = 1;
            downloadButton.style.display = 'none';
            retakeButton.style.display = 'none';
            captureButton.style.display = 'inline-block';
            predictionResult.textContent = "Kết quả nhận diện sẽ hiển thị ở đây.";
            signMeaning.textContent = "";

            // Clear canvas
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Sự kiện khi nhấn nút chụp ảnh
        captureButton.addEventListener('click', capturePhoto);

        // Sự kiện khi nhấn nút tải ảnh xuống
        downloadButton.addEventListener('click', downloadPhoto);

        // Sự kiện khi nhấn nút chụp lại
        retakeButton.addEventListener('click', retakePhoto);

        // Sự kiện khi thay đổi zoom
        zoomSlider.addEventListener('input', () => {
            zoomValue.textContent = `${zoomSlider.value}x`;
        });

        /**
         * Hàm tải mô hình Teachable Machine
         */
        async function loadModel() {
            const modelURLFull = MODEL_URL + "model.json";
            const metadataURL = MODEL_URL + "metadata.json";

            try {
                model = await tmImage.load(modelURLFull, metadataURL);
                maxPredictions = model.getTotalClasses();
                console.log("Mô hình đã được tải thành công.");
                loadingModel.style.display = 'none';
                captureButton.disabled = false;
            } catch (err) {
                console.error("Lỗi khi tải mô hình: ", err);
                alert("Không thể tải mô hình nhận diện. Vui lòng kiểm tra kết nối mạng hoặc URL mô hình.");
                loadingModel.textContent = "Không thể tải mô hình.";
            }
        }

        /**
         * Hàm nhận diện hình ảnh
         */
        async function predictImage() {
            if (!model) {
                predictionResult.textContent = "Mô hình chưa được tải. Vui lòng thử lại sau.";
                loadingPrediction.style.display = 'none';
                return;
            }

            try {
                const prediction = await model.predict(canvas);
                if (prediction.length > 0) {
                    // Sắp xếp các dự đoán theo xác suất giảm dần
                    prediction.sort((a, b) => b.probability - a.probability);
                    // Lấy top prediction
                    const topPrediction = prediction[0];
                    predictionResult.innerHTML = `<span style="color: #28a745;">Kết quả: ${topPrediction.className} (${(topPrediction.probability * 100).toFixed(2)}%)</span>`;

                    // Trích xuất mã biển báo từ kết quả nhận diện
                    const signCode = topPrediction.className.substring(0, 5).toUpperCase(); // Đảm bảo mã là chữ hoa
                    if (signMeanings.hasOwnProperty(signCode)) {
                        signMeaning.textContent = `Ý nghĩa: ${signMeanings[signCode]}`;
                    } else {
                        signMeaning.textContent = "Ý nghĩa: Không tìm thấy ý nghĩa cho biển báo này.";
                    }
                } else {
                    predictionResult.textContent = "Không có kết quả nhận diện.";
                    signMeaning.textContent = "";
                }
            } catch (err) {
                console.error("Lỗi khi nhận diện hình ảnh: ", err);
                predictionResult.textContent = "Lỗi khi nhận diện hình ảnh.";
                signMeaning.textContent = "";
            } finally {
                loadingPrediction.style.display = 'none';
            }
        }

        // Khởi chạy camera và tải mô hình khi trang được tải
        window.addEventListener('load', async () => {
            await loadModel();
            startCamera();
        });

        // Dừng camera khi rời khỏi trang
        window.addEventListener('beforeunload', stopCamera);
    </script>

</body>
</html>
